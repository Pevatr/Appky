<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>OdvykÃ¡nÃ­ â€“ light</title>
<meta name="theme-color" content="#1b873f" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<style>
:root{
  --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
  --accent:#22c55e; --accent-2:#16a34a; --money:#eab308;
  --border:rgba(255,255,255,.1);
  --ok:#86efac; --ok-bg:rgba(34,197,94,.10);
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
html,body{
  margin:0; height:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg); color:var(--text); overscroll-behavior:none;
}

.wrap{
  max-width:480px; margin:0 auto;
  padding:14px 14px calc(14px + env(safe-area-inset-bottom));
  min-height:100dvh; display:flex; flex-direction:column; gap:12px;
}

/* â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€ */
header{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
}
header h1{font-size:1.05rem; margin:0; font-weight:700; color:var(--ok);}
.hbtn{
  height:38px; min-width:38px; padding:0 10px;
  display:inline-flex; align-items:center; justify-content:center; gap:5px;
  border:1px solid var(--border); border-radius:10px;
  background:#0b1220; color:var(--text); font-size:14px; cursor:pointer;
  transition:background .12s ease, transform .06s ease;
  white-space:nowrap;
}
.hbtn:active{transform:scale(.95); background:#0f1b2f;}

/* â”€â”€â”€â”€â”€ KPI HERO â”€â”€â”€â”€â”€ */
.hero{
  background:linear-gradient(135deg, rgba(34,197,94,.08), rgba(255,255,255,.02));
  border:1px solid rgba(34,197,94,.25); border-radius:16px;
  padding:18px 16px 14px; text-align:center;
}
.hero-days{
  font-size:3.8rem; font-weight:900; line-height:1;
  color:#a7f3d0; letter-spacing:-2px;
}
.hero-days-lbl{font-size:.8rem; color:var(--muted); margin-top:2px; margin-bottom:10px;}
.hero-live{font-size:1.5rem; font-weight:700; font-variant-numeric:tabular-nums; color:var(--text);}
.hero-since{font-size:.78rem; color:var(--muted); margin-top:4px;}

.kpi-row{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px;}
.kpi-mini{
  background:rgba(255,255,255,.04); border:1px solid var(--border);
  border-radius:10px; padding:10px 12px;
}
.kpi-mini .lbl{font-size:.75rem; color:var(--muted); margin-bottom:3px;}
.kpi-mini .val{font-size:1rem; font-weight:700; white-space:nowrap;}
.kpi-mini .val.money{color:var(--money);}
.kpi-mini .sub{font-size:.72rem; color:var(--muted); margin-top:2px;}

/* â”€â”€â”€â”€â”€ AKCE â”€â”€â”€â”€â”€ */
.actions{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
.abtn{
  height:56px; border-radius:14px; border:1px solid var(--border);
  background:#0b1220; color:var(--text); font-size:1rem; font-weight:600;
  cursor:pointer; display:flex; align-items:center; justify-content:center; gap:7px;
  transition:background .12s ease, transform .06s ease;
}
.abtn:active{transform:scale(.96); background:#0f1b2f;}
.abtn.accent{
  background:linear-gradient(180deg, var(--accent), var(--accent-2));
  border:none; color:#062814;
}
.abtn.warn{border-color:rgba(239,68,68,.35); color:#fca5a5;}
.abtn.warn:active{background:#1a0a0a;}

/* Toast undo */
.toast{
  position:fixed; left:50%; bottom:calc(18px + env(safe-area-inset-bottom));
  transform:translateX(-50%);
  background:#0b1220; border:1px solid rgba(255,255,255,.14); border-radius:999px;
  padding:9px 16px; color:#e5e7eb; font-size:.9rem;
  display:none; gap:12px; align-items:center; z-index:70; white-space:nowrap;
}
.toast.show{display:flex; animation:fadeIn .12s ease;}
.toast .lnk{color:#86efac; text-decoration:underline; cursor:pointer;}

/* â”€â”€â”€â”€â”€ VÃZVA â”€â”€â”€â”€â”€ */
.challenge-card{
  background:rgba(34,197,94,.06); border:1px solid rgba(34,197,94,.2);
  border-radius:12px; padding:12px 14px;
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
.challenge-card .lbl{font-size:.75rem; color:#a7f3d0; font-weight:700; white-space:nowrap;}
.challenge-card .txt{font-size:.82rem; line-height:1.4; flex:1; min-width:120px;}
.challenge-card .btns{display:flex; gap:5px; flex-shrink:0;}
.challenge-card .streak{font-size:.72rem; color:var(--muted); width:100%;}
.cbtn{
  height:30px; min-width:30px; padding:0 7px; border-radius:7px; font-size:13px;
  border:1px solid var(--border); background:#0b1220; color:var(--text); cursor:pointer;
}
.cbtn:active{transform:scale(.93);}

/* â”€â”€â”€â”€â”€ MILNÃK NEXT â”€â”€â”€â”€â”€ */
.next-milestone{
  background:rgba(59,130,246,.06); border:1px solid rgba(59,130,246,.2);
  border-radius:12px; padding:12px 14px;
}
.nm-top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;}
.nm-icon{font-size:1.3rem;}
.nm-lbl{font-size:.85rem; font-weight:700;}
.nm-pct{font-size:.8rem; color:#93c5fd; font-weight:700;}
.nm-desc{font-size:.78rem; color:var(--muted); margin-bottom:8px;}
.bar{height:6px; background:#0e1a2a; border:1px solid rgba(255,255,255,.06); border-radius:999px; overflow:hidden;}
.bar>div{height:100%; background:linear-gradient(90deg, #3b82f6, #22c55e); transition:width .3s ease;}

/* â”€â”€â”€â”€â”€ MODAL Den D â”€â”€â”€â”€â”€ */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:none; align-items:flex-end; justify-content:center; z-index:80;
}
.modal-backdrop.open{display:flex; animation:fadeIn .15s ease;}
.modal{
  background:#0b1220; border:1px solid var(--border);
  border-radius:16px 16px 0 0; width:100%; max-width:480px;
  padding:20px 16px calc(20px + env(safe-area-inset-bottom));
}
.modal h2{margin:0 0 14px; font-size:1rem;}
.modal label{display:block; font-size:.82rem; color:#a9bed3; margin-bottom:4px;}
.modal input{
  width:100%; height:42px; padding:8px 12px; border-radius:9px;
  border:1px solid rgba(255,255,255,.14); background:#0c1422; color:var(--text);
  font-size:1rem; margin-bottom:14px;
}
.modal-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:4px;}
.mbtn{
  height:40px; padding:0 16px; border-radius:9px; font-size:.9rem; font-weight:600; cursor:pointer;
  border:1px solid rgba(255,255,255,.15); background:#0b1220; color:#e5e7eb;
}
.mbtn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2)); border:none; color:#062814;}

/* â”€â”€â”€â”€â”€ CRAVING MODAL â”€â”€â”€â”€â”€ */
.craving-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.65);
  display:none; align-items:flex-end; justify-content:center; z-index:80;
}
.craving-backdrop.open{display:flex; animation:fadeIn .15s ease;}
.craving-sheet{
  background:#0b1220; border:1px solid var(--border);
  border-radius:16px 16px 0 0; width:100%; max-width:480px;
  padding:20px 16px calc(16px + env(safe-area-inset-bottom));
  max-height:85vh; display:flex; flex-direction:column;
}
.craving-sheet h2{margin:0 0 4px; font-size:1.05rem;}
.craving-sheet .sub{font-size:.8rem; color:var(--muted); margin-bottom:12px;}
.craving-info{
  background:rgba(59,130,246,.08); border:1px solid rgba(59,130,246,.2);
  border-radius:9px; padding:9px 12px; font-size:.82rem; color:#93c5fd;
  text-align:center; margin-bottom:12px;
}
.craving-list{overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:6px; max-height:220px;}
.craving-item{
  display:flex; align-items:center; gap:8px;
  background:rgba(255,255,255,.04); border-radius:8px; padding:8px 10px;
}
.craving-item .num{font-size:.72rem; color:var(--muted); min-width:22px; text-align:right;}
.craving-item .dt{font-size:.82rem; flex:1;}
.craving-item .ok{font-size:.75rem; color:#22c55e;}
.craving-item .del{
  background:none; border:1px solid rgba(255,80,80,.3); border-radius:5px;
  color:#f87171; font-size:.75rem; padding:2px 6px; cursor:pointer; flex-shrink:0;
}
.craving-empty{color:var(--muted); font-size:.82rem; text-align:center; padding:18px 0;}

/* â”€â”€â”€â”€â”€ FALEÅ NÃ OBRAZOVKA â”€â”€â”€â”€â”€ */
#fakeScreen{
  display:none; position:fixed; inset:0; background:#0f172a; z-index:200;
  flex-direction:column; align-items:center; justify-content:center; gap:18px;
}

/* â”€â”€â”€â”€â”€ UTILS â”€â”€â”€â”€â”€ */
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <header>
    <h1>ğŸš­ OdvykÃ¡nÃ­</h1>
    <div style="display:flex;gap:6px;">
      <button class="hbtn" id="btnEditDday" title="Nastavit Den D">âœï¸ Den D</button>
      <button class="hbtn" id="btnFakeScreen" title="FaleÅ¡nÃ¡ obrazovka">ğŸ­</button>
    </div>
  </header>

  <!-- HERO KPI -->
  <div class="hero">
    <div class="hero-days" id="heroDays">â€”</div>
    <div class="hero-days-lbl">dnÅ¯ bez cigarety</div>
    <div class="hero-live" id="heroLive">00:00:00</div>
    <div class="hero-since" id="heroSince">ZahÃ¡jenÃ­: â€”</div>

    <div class="kpi-row">
      <div class="kpi-mini">
        <div class="lbl">UÅ¡etÅ™eno (ÄistÃ©)</div>
        <div class="val money" id="kNet">0,00 KÄ</div>
        <div class="sub" id="kGross"></div>
      </div>
      <div class="kpi-mini">
        <div class="lbl">PoslednÃ­ nÃ¡plast</div>
        <div class="val" id="kPatch">â€”</div>
        <div class="sub" id="kPatchSince"></div>
      </div>
    </div>
  </div>

  <!-- AKCE -->
  <div class="actions">
    <button class="abtn accent" id="btnPatch">ğŸ©¹ NÃ¡plast</button>
    <button class="abtn warn" id="btnCraving">ğŸš¨ Craving <span id="cravingBadge" style="background:rgba(239,68,68,.2);border-radius:999px;padding:1px 7px;font-size:.8rem;">0</span></button>
  </div>

  <!-- DENNÃ VÃZVA -->
  <div class="challenge-card">
    <span class="lbl">ğŸ¯ DennÃ­ vÃ½zva</span>
    <span class="txt" id="challengeText">NaÄÃ­tÃ¡mâ€¦</span>
    <div class="btns">
      <button class="cbtn" id="btnChallengeDone" title="SplnÄ›no">âœ…</button>
      <button class="cbtn" id="btnNewChallenge" title="NovÃ¡ vÃ½zva">ğŸ”„</button>
    </div>
    <div class="streak">SÃ©rie: <span id="challengeStreak">0 dnÃ­</span></div>
  </div>

  <!-- NEJBLIÅ½Å Ã MILNÃK -->
  <div class="next-milestone" id="nextMilestoneCard" style="display:none;">
    <div class="nm-top">
      <span><span class="nm-icon" id="nmIcon">â­</span> <span class="nm-lbl" id="nmLabel">â€”</span></span>
      <span class="nm-pct" id="nmPct">0 %</span>
    </div>
    <div class="nm-desc" id="nmDesc"></div>
    <div class="bar"><div id="nmBar" style="width:0%"></div></div>
  </div>

</div>

<!-- TOAST -->
<div id="toast" class="toast" role="status">
  <span>ğŸ©¹ PÅ™idÃ¡no</span>
  <span id="toastUndo" class="lnk">ZpÄ›t</span>
</div>

<!-- MODAL: Den D -->
<div id="ddayModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog">
    <h2>âœï¸ Nastavit Den D</h2>
    <label for="ddayInput">Datum a Äas zahÃ¡jenÃ­</label>
    <input id="ddayInput" type="datetime-local" />
    <div class="modal-actions">
      <button class="mbtn" id="btnDdayCancel">ZruÅ¡it</button>
      <button class="mbtn primary" id="btnDdaySave">UloÅ¾it</button>
    </div>
  </div>
</div>

<!-- CRAVING MODAL -->
<div id="cravingModal" class="craving-backdrop" aria-hidden="true">
  <div class="craving-sheet">
    <h2>ğŸš¨ Craving â€“ pÅ™ekonej ho!</h2>
    <div class="sub">Celkem pÅ™ekonÃ¡no: <span id="cravingTotal" style="color:#22c55e;font-weight:700;">0</span></div>
    <div class="craving-info">â±ï¸ Craving trvÃ¡ maximÃ¡lnÄ› 3â€“5 minut. VydrÅ¾Ã­Å¡!</div>
    <button id="btnCravingConfirm" style="height:48px;border-radius:10px;font-size:1rem;font-weight:700;background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;color:#062814;cursor:pointer;margin-bottom:12px;">ğŸ’ª VydrÅ¾Ã­m!</button>
    <div class="craving-list" id="cravingList">
      <div class="craving-empty">ZatÃ­m Å¾Ã¡dnÃ½ craving nezaznamenÃ¡n.</div>
    </div>
    <button id="btnCravingClose" style="height:40px;border-radius:9px;border:1px solid var(--border);background:#0b1220;color:var(--text);cursor:pointer;margin-top:10px;font-size:.9rem;">ZavÅ™Ã­t</button>
  </div>
</div>

<!-- FALEÅ NÃ OBRAZOVKA -->
<div id="fakeScreen">
  <div style="font-size:2.2rem;">ğŸ“</div>
  <div style="font-size:1.3rem;font-weight:700;color:var(--text);">PoznÃ¡mky</div>
  <textarea placeholder="Zde jsou vaÅ¡e poznÃ¡mkyâ€¦"
    style="width:min(360px,88vw);height:180px;background:#1e293b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;color:var(--text);font-size:.95rem;resize:none;"></textarea>
  <small style="color:var(--muted);">PodrÅ¾te 2 sekundy pro nÃ¡vrat</small>
</div>

<script>
// â”€â”€â”€ STORAGE KEYS (stejnÃ© jako v hlavnÃ­ verzi) â”€â”€â”€
const STATE_KEY  = 'quitStateSimple';
const PATCH_KEY  = 'patchData';
const CRAVING_KEY = 'cravings';
const DAILY_KEY  = 'dailyChallenge';
const STREAK_KEY = 'challengeStreak';

const DEFAULTS = {
  quit:"", prevQuit:"", perDay:15, curr:'KÄ',
  minPerCig:5, showKPI:true, packCigs:20, packPrice:150, note:""
};
const PATCH_DEFAULTS = { pricePer:0, packPrice:0, packCount:0, brand:"Nicorette", strength:14, apps:[] };

function loadState(){
  try{ return {...DEFAULTS, ...JSON.parse(localStorage.getItem(STATE_KEY)||'{}')}; }
  catch(_){ return {...DEFAULTS}; }
}
function saveState(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)); }

function loadPatches(){
  try{
    const raw = JSON.parse(localStorage.getItem(PATCH_KEY)||'{}');
    const p = {...PATCH_DEFAULTS, ...(raw||{})};
    const per = (p.packPrice>0 && p.packCount>0) ? (p.packPrice/p.packCount) : p.pricePer;
    p.pricePer = Number.isFinite(per) ? per : 0;
    p.apps = Array.isArray(p.apps) ? p.apps : [];
    return p;
  }catch(_){ return {...PATCH_DEFAULTS}; }
}
function savePatches(p){ localStorage.setItem(PATCH_KEY, JSON.stringify(p)); }

function loadCravings(){ try{ return JSON.parse(localStorage.getItem(CRAVING_KEY)||'[]'); }catch(_){ return []; } }
function saveCravings(a){ localStorage.setItem(CRAVING_KEY, JSON.stringify(a)); }

// â”€â”€â”€ UTILS â”€â”€â”€
const $ = id => document.getElementById(id);
const DAY_MS = 86400000;
const pad2 = n => String(n).padStart(2,'0');

function fmtDate(d){
  if(!d) return 'â€”';
  const x = d instanceof Date ? d : new Date(d);
  if(isNaN(x)) return 'â€”';
  return x.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
}
function fmtMoney(n, curr){
  const v = Math.round((n||0)*100)/100;
  return v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+' '+(curr||'KÄ');
}
function fmtHHMMSS(ms){
  const s = Math.floor(ms/1000);
  const hh = Math.floor(s/3600), mm = Math.floor((s%3600)/60), ss = s%60;
  return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
}
function fmtDDHHMM(ms){
  const d = Math.floor(ms/DAY_MS);
  const h = Math.floor((ms/3600000)%24);
  const m = Math.floor((ms/60000)%60);
  return `${d}:${pad2(h)}:${pad2(m)}`;
}
function nowLocal(){
  const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,16);
}
function clamp01(x){ return Math.max(0,Math.min(1,x)); }

// â”€â”€â”€ MILESTONES (klÃ­ÄovÃ©) â”€â”€â”€
const MS_KEY = [
  {key:'20m',  icon:'âŒ›', label:'20 minut',   hours:0.33,      desc:'Tlak a puls se vracÃ­ k normÄ›.'},
  {key:'12h',  icon:'ğŸ«', label:'12 hodin',   hours:12,        desc:'Krev lÃ©pe nese kyslÃ­k.'},
  {key:'24h',  icon:'ğŸ«€', label:'24 hodin',   hours:24,        desc:'Srdce mÃ¡ o nÄ›co mÃ©nÄ› prÃ¡ce.'},
  {key:'7d',   icon:'ğŸ…', label:'7 dnÃ­',      hours:24*7,      desc:'PrvnÃ­ tÃ½den je velkÃ½ ÃºspÄ›ch.'},
  {key:'30d',  icon:'ğŸŒ¿', label:'30 dnÃ­',     hours:24*30,     desc:'MÄ›sÃ­c bez kouÅ™e je velkÃ½ milnÃ­k.'},
  {key:'90d',  icon:'ğŸ', label:'90 dnÃ­',     hours:24*90,     desc:'TÅ™i mÄ›sÃ­ce bez kouÅ™e.'},
  {key:'6m',   icon:'ğŸ’“', label:'6 mÄ›sÃ­cÅ¯',   hours:24*30*6,   desc:'KaÅ¡el a duÅ¡nost ustupujÃ­.'},
  {key:'1y',   icon:'â¤ï¸', label:'1 rok',      hours:24*365,    desc:'Riziko srdeÄnÃ­ch chorob klesÃ¡.'},
  {key:'5y',   icon:'ğŸ›¡ï¸', label:'5 let',      hours:24*365*5,  desc:'Riziko mrtvice vÃ½raznÄ› klesÃ¡.'},
  {key:'10y',  icon:'ğŸ¯', label:'10 let',     hours:24*365*10, desc:'Riziko rakoviny plic je niÅ¾Å¡Ã­.'},
];

// â”€â”€â”€ COMPUTE â”€â”€â”€
function compute(){
  const s = loadState();
  const p = loadPatches();
  const quitDate = s.quit ? new Date(s.quit) : null;
  const now = new Date();
  const diffMs = (!quitDate || isNaN(quitDate)) ? 0 : Math.max(0, now - quitDate);
  const daysFloat = diffMs / DAY_MS;

  const perDay = Math.max(0, parseInt(s.perDay)||15);
  const packCigs = Math.max(1, parseInt(s.packCigs)||20);
  const packPrice = Math.max(0, parseFloat(s.packPrice)||150);
  const perDayMoney = (perDay/packCigs)*packPrice;
  const savedGross = Math.round(daysFloat*perDayMoney*100)/100;
  const patchCost = Math.round((p.apps.length)*(p.pricePer||0)*100)/100;
  const savedNet = Math.round((savedGross - patchCost)*100)/100;

  const milestones = MS_KEY.map(m=>{
    const ratio = quitDate ? clamp01((now-quitDate)/(m.hours*3600000)) : 0;
    return {...m, ratio, done: ratio>=1, pct: Math.round(ratio*100)};
  });

  return {s, p, quitDate, diffMs, daysFloat, savedGross, patchCost, savedNet, milestones};
}

// â”€â”€â”€ RENDER â”€â”€â”€
function render(){
  const R = compute();

  // Hero days
  const days = Math.floor(R.daysFloat);
  $('heroDays').textContent = R.quitDate ? days : 'â€”';
  $('heroLive').textContent = R.quitDate ? fmtHHMMSS(R.diffMs) : 'â€”:â€”:â€”';
  $('heroSince').textContent = R.quitDate ? 'ZahÃ¡jenÃ­: ' + fmtDate(R.quitDate) : 'Den D nenÃ­ nastaven';

  // KPI mini
  $('kNet').textContent = fmtMoney(R.savedNet, R.s.curr);
  $('kGross').textContent = R.quitDate ? 'Brutto: ' + fmtMoney(R.savedGross, R.s.curr) : '';

  // NÃ¡plast
  const pa = R.p.apps;
  if(pa.length){
    const last = Number(pa[pa.length-1]);
    const diff = Math.max(0, Date.now()-last);
    $('kPatch').textContent = fmtDDHHMM(diff);
    $('kPatchSince').textContent = fmtDate(last);
  } else {
    $('kPatch').textContent = 'â€”';
    $('kPatchSince').textContent = '';
  }

  // NejbliÅ¾Å¡Ã­ milnÃ­k
  const next = R.milestones.find(m => !m.done);
  if(next && R.quitDate){
    $('nextMilestoneCard').style.display = 'block';
    $('nmIcon').textContent = next.icon;
    $('nmLabel').textContent = next.label;
    $('nmDesc').textContent = next.desc;
    $('nmPct').textContent = next.pct + ' %';
    $('nmBar').style.width = next.pct + '%';
  } else {
    $('nextMilestoneCard').style.display = R.quitDate ? 'block' : 'none';
    if(R.quitDate){
      $('nmIcon').textContent = 'ğŸŒ³';
      $('nmLabel').textContent = 'VÅ¡echny milnÃ­ky splnÄ›ny!';
      $('nmDesc').textContent = 'SkvÄ›lÃ¡ prÃ¡ce.';
      $('nmPct').textContent = '100 %';
      $('nmBar').style.width = '100%';
    }
  }

  // Craving badge
  const cArr = loadCravings();
  $('cravingBadge').textContent = cArr.length;
  $('cravingTotal').textContent = cArr.length;
  $('cravingBadge').style.display = cArr.length ? '' : 'none';
}

// â”€â”€â”€ TOAST â”€â”€â”€
let toastTimer = 0;
function showToast(){
  clearTimeout(toastTimer);
  const t = $('toast'); t.classList.add('show');
  toastTimer = setTimeout(()=>t.classList.remove('show'), 5000);
}
function hideToast(){ clearTimeout(toastTimer); $('toast').classList.remove('show'); }

// â”€â”€â”€ PATCH â”€â”€â”€
function quickAddPatch(){
  const d = loadPatches();
  d.apps.push(Date.now());
  savePatches(d); render(); showToast();
}
function toastUndoPatch(){
  const d = loadPatches();
  if(d.apps.length){ d.apps.pop(); savePatches(d); render(); }
  hideToast();
}

// â”€â”€â”€ DEN D MODAL â”€â”€â”€
function openDdayModal(){
  const s = loadState();
  const current = s.quit ? new Date(s.quit) : new Date();
  const yyyy = current.getFullYear();
  const mm = String(current.getMonth()+1).padStart(2,'0');
  const dd = String(current.getDate()).padStart(2,'0');
  const hh = String(current.getHours()).padStart(2,'0');
  const mi = String(current.getMinutes()).padStart(2,'0');
  $('ddayInput').value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  $('ddayModal').classList.add('open');
  $('ddayModal').setAttribute('aria-hidden','false');
}
function closeDdayModal(){
  $('ddayModal').classList.remove('open');
  $('ddayModal').setAttribute('aria-hidden','true');
}
function saveDday(){
  const val = $('ddayInput').value;
  if(!val){ closeDdayModal(); return; }
  const s = loadState();
  s.prevQuit = s.quit ?? "";
  s.quit = val;
  saveState(s); render(); closeDdayModal();
}

// â”€â”€â”€ CRAVING â”€â”€â”€
function openCravingModal(){
  renderCravingList();
  $('cravingModal').classList.add('open');
  $('cravingModal').setAttribute('aria-hidden','false');
}
function closeCravingModal(){
  $('cravingModal').classList.remove('open');
  $('cravingModal').setAttribute('aria-hidden','true');
}
function confirmCraving(){
  const arr = loadCravings();
  arr.push(Date.now());
  saveCravings(arr);
  render(); renderCravingList();
  const btn = $('btnCravingConfirm');
  btn.textContent = 'âœ… ZaznamenÃ¡no!'; btn.disabled = true;
  setTimeout(()=>{ btn.textContent = 'ğŸ’ª VydrÅ¾Ã­m!'; btn.disabled = false; }, 2000);
}
function deleteCraving(i){
  const arr = loadCravings();
  arr.splice(i,1); saveCravings(arr);
  render(); renderCravingList();
}
function renderCravingList(){
  const arr = loadCravings();
  const list = $('cravingList');
  $('cravingTotal').textContent = arr.length;
  if(!arr.length){
    list.innerHTML = '<div class="craving-empty">ZatÃ­m Å¾Ã¡dnÃ½ craving nezaznamenÃ¡n.</div>';
    return;
  }
  list.innerHTML = arr.slice().reverse().map((ts,i)=>{
    const orig = arr.length-1-i;
    const d = new Date(Number(ts));
    const dt = d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const num = arr.length-i;
    return `<div class="craving-item">
      <span class="num">#${num}</span>
      <span class="dt">${dt}</span>
      <span class="ok">âœ“ pÅ™ekonÃ¡no</span>
      <button class="del" onclick="deleteCraving(${orig})">ğŸ—‘</button>
    </div>`;
  }).join('');
}

// â”€â”€â”€ DENNÃ VÃZVA â”€â”€â”€
const CHALLENGES = [
  'ğŸƒ Zajdi na prochÃ¡zku alespoÅˆ 15 minut.',
  'ğŸ˜´ Dnes si lehni spÃ¡t o 30 minut dÅ™Ã­ve.',
  'ğŸµ VyzkouÅ¡ej bylinnÃ½ Äaj mÃ­sto kÃ¡vy.',
  'ğŸ“– PÅ™eÄti si jednu inspirativnÃ­ strÃ¡nku nebo ÄlÃ¡nek.',
  'ğŸŒ³ StrÃ¡v 10 minut v pÅ™Ã­rodÄ› nebo u otevÅ™enÃ©ho okna.',
  'ğŸ’ª UdÄ›lej 3 sÃ©rie po 10 dÅ™epech kdykoli ucÃ­tÃ­Å¡ craving.',
  'ğŸ¤ Å˜ekni dnes "ne" jednÃ© zbyteÄnÃ© situaci.',
  'ğŸ¯ StanovÃ­ si jeden malÃ½ cÃ­l na dneÅ¡nÃ­ den a splÅˆ ho.',
  'ğŸ› DopÅ™ej si relaxaÄnÃ­ koupel nebo sprchu.',
  'ğŸ“¸ VyfoÅ¥ nÄ›co krÃ¡snÃ©ho co bys dÅ™Ã­v pÅ™ehlÃ©dl.',
  'ğŸ§¹ UkliÄ jedno mÃ­sto v bytÄ› â€“ fyzickÃ¡ aktivita pomÃ¡hÃ¡.',
  'ğŸŒ… RÃ¡no se 5 minut dÃ­vej z okna bez telefonu.'
];
function getTodayChallenge(){
  const dayKey = new Date().toISOString().slice(0,10);
  const stored = localStorage.getItem(DAILY_KEY);
  if(stored){ try{ const o=JSON.parse(stored); if(o.day===dayKey) return o; }catch(_){} }
  const idx = Math.floor(Math.random()*CHALLENGES.length);
  const obj = {day:dayKey, idx, done:false};
  localStorage.setItem(DAILY_KEY, JSON.stringify(obj));
  return obj;
}
function renderChallenge(){
  const obj = getTodayChallenge();
  const full = CHALLENGES[obj.idx];
  $('challengeText').textContent = full.length>70 ? full.slice(0,67)+'â€¦' : full;
  const btn = $('btnChallengeDone');
  btn.style.opacity = obj.done ? '.45' : '1';
  btn.disabled = obj.done;
  const streak = parseInt(localStorage.getItem(STREAK_KEY)||'0');
  $('challengeStreak').textContent = streak + ' dnÃ­';
}
function completeChallenge(){
  const obj = getTodayChallenge();
  if(obj.done) return;
  obj.done = true;
  localStorage.setItem(DAILY_KEY, JSON.stringify(obj));
  const streak = parseInt(localStorage.getItem(STREAK_KEY)||'0');
  localStorage.setItem(STREAK_KEY, String(streak+1));
  renderChallenge();
}
function newChallenge(){
  const dayKey = new Date().toISOString().slice(0,10);
  const used = JSON.parse(localStorage.getItem('usedChallenges')||'[]');
  let idx;
  do{ idx = Math.floor(Math.random()*CHALLENGES.length); }
  while(used.includes(idx) && used.length < CHALLENGES.length);
  const newUsed = [...used.filter(i=>i!==idx), idx].slice(-10);
  localStorage.setItem('usedChallenges', JSON.stringify(newUsed));
  const obj = {day:dayKey, idx, done:false};
  localStorage.setItem(DAILY_KEY, JSON.stringify(obj));
  renderChallenge();
}

// â”€â”€â”€ FALEÅ NÃ OBRAZOVKA â”€â”€â”€
let fakeHoldTimer = null;
function activateFakeScreen(){
  const fs = $('fakeScreen');
  fs.style.display = 'flex';
  fs.addEventListener('pointerdown', startFakeExit);
  fs.addEventListener('pointerup', cancelFakeExit);
}
function startFakeExit(){ fakeHoldTimer = setTimeout(deactivateFakeScreen, 2000); }
function cancelFakeExit(){ clearTimeout(fakeHoldTimer); }
function deactivateFakeScreen(){
  const fs = $('fakeScreen');
  if(fs) fs.style.display = 'none';
}

// â”€â”€â”€ INIT â”€â”€â”€
document.addEventListener('DOMContentLoaded', ()=>{

  // Den D
  $('btnEditDday').onclick = openDdayModal;
  $('btnDdayCancel').onclick = closeDdayModal;
  $('btnDdaySave').onclick = saveDday;
  $('ddayModal').addEventListener('click', e=>{ if(e.target===$('ddayModal')) closeDdayModal(); });

  // NÃ¡plast
  $('btnPatch').onclick = quickAddPatch;
  $('toastUndo').onclick = toastUndoPatch;

  // Craving
  $('btnCraving').onclick = openCravingModal;
  $('btnCravingConfirm').onclick = confirmCraving;
  $('btnCravingClose').onclick = closeCravingModal;
  $('cravingModal').addEventListener('click', e=>{ if(e.target===$('cravingModal')) closeCravingModal(); });

  // VÃ½zva
  $('btnChallengeDone').onclick = completeChallenge;
  $('btnNewChallenge').onclick = newChallenge;

  // FaleÅ¡nÃ¡ obrazovka
  $('btnFakeScreen').onclick = activateFakeScreen;

  // Escape
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape'){ closeDdayModal(); closeCravingModal(); }
  });

  // PrvnÃ­ render + interval
  render(); renderChallenge();
  setInterval(render, 1000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ render(); renderChallenge(); } });
});
</script>
</body>
</html>
