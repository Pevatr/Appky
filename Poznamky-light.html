<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pozn√°mky ‚Äì rychl√Ω z√°znam</title>
<meta name="theme-color" content="#0f172a" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<style>
:root {
  --bg:      #0f172a;
  --surface: #0b1220;
  --surface2:#111827;
  --border:  rgba(255,255,255,.09);
  --text:    #e5e7eb;
  --muted:   #64748b;
  --accent:  #22c55e;
  --accent2: #16a34a;

  --c-yellow: #eab308;
  --c-green:  #22c55e;
  --c-blue:   #3b82f6;
  --c-purple: #a855f7;
  --c-pink:   #ec4899;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
html, body {
  height: 100%; background: var(--bg); color: var(--text);
  font-family: ui-rounded, system-ui, -apple-system, sans-serif;
  overscroll-behavior: none;
}

.app {
  max-width: 430px; margin: 0 auto;
  min-height: 100dvh; display: flex; flex-direction: column;
  padding-bottom: env(safe-area-inset-bottom);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr {
  padding: 16px 16px 10px;
  padding-top: calc(14px + env(safe-area-inset-top));
  display: flex; align-items: center; justify-content: space-between; gap: 8px;
}
.hdr-title {
  font-size: .72rem; font-weight: 700; letter-spacing: .12em;
  text-transform: uppercase; color: var(--muted);
}
.hdr-right { display: flex; gap: 6px; align-items: center; }
.hbtn {
  height: 34px; min-width: 34px; padding: 0 10px;
  border-radius: 9px; border: 1px solid var(--border);
  background: var(--surface); color: var(--muted);
  font-size: .78rem; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 4px;
  transition: background .1s, color .1s;
  white-space: nowrap;
}
.hbtn:active { background: #1e2a3d; }
.hbtn.active { color: var(--accent); border-color: rgba(34,197,94,.35); }

/* ‚îÄ‚îÄ COUNTER ‚îÄ‚îÄ */
.counter {
  padding: 2px 16px 10px;
  font-size: .78rem; color: var(--muted);
}
.counter span { color: var(--text); font-weight: 700; }

/* ‚îÄ‚îÄ QUICK INPUT ‚îÄ‚îÄ */
.quick-block {
  margin: 0 12px 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px 12px 10px;
  display: flex; flex-direction: column; gap: 8px;
  transition: border-color .15s;
}
.quick-block:focus-within { border-color: rgba(34,197,94,.35); }

.quick-top {
  display: flex; gap: 8px; align-items: flex-start;
}
.quick-title {
  flex: 1; height: 42px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text);
  font-size: .95rem; font-weight: 600;
  padding: 0 12px; outline: none;
  transition: border-color .15s;
}
.quick-title:focus { border-color: rgba(34,197,94,.3); }
.quick-title::placeholder { color: var(--muted); font-weight: 400; }

.quick-send {
  height: 42px; width: 42px; flex-shrink: 0;
  border-radius: 10px; border: none;
  background: linear-gradient(160deg, var(--accent), var(--accent2));
  color: #052e16; font-size: 1.1rem; font-weight: 800;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: opacity .12s, transform .06s;
}
.quick-send:active { transform: scale(.92); opacity: .8; }
.quick-send:disabled { opacity: .35; cursor: not-allowed; }

/* expand area */
.quick-more {
  display: none;
  flex-direction: column;
  gap: 8px;
  animation: fadeDown .15s ease;
}
.quick-more.open { display: flex; }
@keyframes fadeDown {
  from { opacity: 0; transform: translateY(-4px); }
  to   { opacity: 1; transform: translateY(0); }
}

.quick-body {
  width: 100%; min-height: 80px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text);
  font-size: .88rem; padding: 10px 12px; outline: none;
  resize: none; font-family: inherit;
  transition: border-color .15s;
}
.quick-body:focus { border-color: rgba(34,197,94,.25); }
.quick-body::placeholder { color: var(--muted); }

.quick-bottom {
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
}

/* kategorie v quick */
.cats-row {
  display: flex; gap: 5px; flex-wrap: wrap; flex: 1;
}
.cat-chip {
  height: 28px; padding: 0 9px;
  border-radius: 999px; border: 1px solid var(--border);
  background: var(--surface2); color: var(--muted);
  font-size: .72rem; font-weight: 600; cursor: pointer;
  transition: background .1s, border-color .1s, color .1s;
  white-space: nowrap;
}
.cat-chip.sel {
  background: rgba(34,197,94,.12);
  border-color: rgba(34,197,94,.45);
  color: #a7f3d0;
}

/* barevn√© teƒçky */
.palette-row { display: flex; gap: 6px; align-items: center; }
.dot {
  width: 18px; height: 18px; border-radius: 50%;
  cursor: pointer; border: 2px solid transparent;
  transition: transform .1s, box-shadow .1s;
  flex-shrink: 0;
}
.dot:active { transform: scale(.85); }
.dot.sel { box-shadow: 0 0 0 2px rgba(255,255,255,.4); }
.dot[data-c="none"]   { background: var(--surface2); border-color: var(--border); }
.dot[data-c="yellow"] { background: var(--c-yellow); }
.dot[data-c="green"]  { background: var(--c-green); }
.dot[data-c="blue"]   { background: var(--c-blue); }
.dot[data-c="purple"] { background: var(--c-purple); }
.dot[data-c="pink"]   { background: var(--c-pink); }

.expand-toggle {
  font-size: .72rem; color: var(--muted); cursor: pointer;
  text-decoration: underline; text-underline-offset: 2px;
  background: none; border: none; padding: 0; margin-left: auto;
  flex-shrink: 0;
}
.expand-toggle:active { color: var(--accent); }

/* ‚îÄ‚îÄ FILTR CHIPS ‚îÄ‚îÄ */
.filter-row {
  padding: 0 12px 8px;
  display: flex; gap: 5px; overflow-x: auto;
  scrollbar-width: none;
}
.filter-row::-webkit-scrollbar { display: none; }
.fchip {
  height: 28px; padding: 0 10px; flex-shrink: 0;
  border-radius: 999px; border: 1px solid var(--border);
  background: var(--surface); color: var(--muted);
  font-size: .72rem; font-weight: 600; cursor: pointer;
  white-space: nowrap; transition: background .1s, color .1s, border-color .1s;
}
.fchip.active {
  background: rgba(34,197,94,.1);
  border-color: rgba(34,197,94,.4);
  color: #a7f3d0;
}

/* ‚îÄ‚îÄ SEZNAM ‚îÄ‚îÄ */
.notes-list {
  flex: 1; overflow-y: auto;
  padding: 0 12px 16px;
  display: flex; flex-direction: column; gap: 7px;
}

.note-card {
  display: flex; gap: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  animation: slideIn .16s ease;
  transition: background .1s;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-5px); }
  to   { opacity: 1; transform: translateY(0); }
}
.note-bar {
  width: 4px; flex-shrink: 0;
  background: transparent;
}
.note-body {
  flex: 1; padding: 10px 10px 10px 10px; min-width: 0;
  cursor: pointer;
}
.note-head {
  display: flex; align-items: baseline; gap: 6px; margin-bottom: 2px;
}
.note-icon { font-size: .9rem; flex-shrink: 0; }
.note-title {
  font-size: .9rem; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  flex: 1;
}
.note-preview {
  font-size: .78rem; color: #9ca3af;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
  line-height: 1.45;
}
.note-meta {
  font-size: .68rem; color: var(--muted); margin-top: 4px;
}
.note-actions {
  display: flex; flex-direction: column;
  justify-content: center; gap: 4px;
  padding: 8px 8px 8px 4px; flex-shrink: 0;
}
.nact {
  width: 28px; height: 28px; border-radius: 7px;
  border: 1px solid var(--border); background: transparent;
  color: var(--muted); font-size: .85rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .1s, color .1s;
}
.nact:active { background: rgba(255,255,255,.07); color: var(--text); }
.nact.pin-on { color: #fbbf24; border-color: rgba(251,191,36,.3); }

.empty {
  text-align: center; color: var(--muted);
  font-size: .85rem; padding: 40px 0;
}

/* ‚îÄ‚îÄ EDIT SHEET ‚îÄ‚îÄ */
.sheet-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,.55);
  display: none; align-items: flex-end; justify-content: center; z-index: 80;
}
.sheet-backdrop.open { display: flex; animation: fadeIn .15s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.sheet {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 18px 18px 0 0;
  width: 100%; max-width: 430px;
  padding: 20px 16px calc(20px + env(safe-area-inset-bottom));
  max-height: 92dvh; display: flex; flex-direction: column; gap: 10px;
  overflow-y: auto;
}
.sheet-handle {
  width: 36px; height: 4px; border-radius: 2px;
  background: rgba(255,255,255,.15); margin: -8px auto 4px;
  flex-shrink: 0;
}
.sheet h2 { font-size: .95rem; font-weight: 700; }
.sheet label { font-size: .75rem; color: var(--muted); margin-bottom: 3px; display: block; }
.sheet input, .sheet textarea, .sheet select {
  width: 100%; padding: 10px 12px; border-radius: 10px;
  border: 1px solid var(--border); background: var(--surface2);
  color: var(--text); font-size: .9rem; font-family: inherit; outline: none;
  transition: border-color .15s;
}
.sheet input:focus, .sheet textarea:focus { border-color: rgba(34,197,94,.3); }
.sheet textarea { min-height: 100px; resize: none; }
.sheet-actions {
  display: flex; gap: 7px; flex-wrap: wrap; margin-top: 4px;
}
.sbtn {
  height: 40px; padding: 0 14px; border-radius: 9px;
  border: 1px solid var(--border); background: var(--surface2);
  color: var(--text); font-size: .85rem; font-weight: 600; cursor: pointer;
  transition: background .1s;
}
.sbtn:active { background: #1e2a3d; }
.sbtn.primary {
  background: linear-gradient(160deg, var(--accent), var(--accent2));
  border: none; color: #052e16;
}
.sbtn.danger { color: #fca5a5; border-color: rgba(239,68,68,.25); }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; left: 50%;
  bottom: calc(18px + env(safe-area-inset-bottom));
  transform: translateX(-50%) translateY(10px);
  background: var(--surface2); border: 1px solid rgba(255,255,255,.12);
  border-radius: 999px; padding: 9px 16px;
  display: flex; gap: 10px; align-items: center;
  font-size: .85rem; color: var(--text); white-space: nowrap;
  z-index: 99; opacity: 0; pointer-events: none;
  transition: opacity .16s, transform .16s;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
.toast-undo { color: var(--accent); text-decoration: underline; cursor: pointer; font-weight: 700; }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-title">üìù Pozn√°mky</div>
    <div class="hdr-right">
      <button class="hbtn" id="btnSearch" title="Hledat">üîç</button>
      <button class="hbtn" id="btnArchive">üì¶ Archiv</button>
    </div>
  </div>

  <!-- POƒåET -->
  <div class="counter" id="counter"></div>

  <!-- RYCHL√ù Z√ÅPIS -->
  <div class="quick-block" id="quickBlock">
    <div class="quick-top">
      <input class="quick-title" id="qTitle" type="text"
             placeholder="Rychl√° pozn√°mka‚Ä¶" autocomplete="off" />
      <button class="quick-send" id="btnSend" disabled>‚Üë</button>
    </div>

    <!-- rozbalovac√≠ ƒç√°st -->
    <div class="quick-more" id="qMore">
      <textarea class="quick-body" id="qBody" placeholder="Text (volitelnƒõ)‚Ä¶" rows="3"></textarea>
      <div class="quick-bottom">
        <div class="cats-row" id="qCats"></div>
        <div class="palette-row" id="qPalette"></div>
        <button class="expand-toggle" id="btnCollapse">m√©nƒõ ‚ñ≤</button>
      </div>
    </div>

    <!-- ≈ô√°dek s expand a kategoriemi v kompaktn√≠m stavu -->
    <div id="qCompact" style="display:flex; align-items:center; gap:6px;">
      <div class="cats-row" id="qCatsCompact"></div>
      <button class="expand-toggle" id="btnExpand">v√≠ce ‚ñº</button>
    </div>
  </div>

  <!-- HLEDAT (skryt√©) -->
  <div id="searchBar" style="display:none; padding:0 12px 8px;">
    <input id="qSearch" type="text" placeholder="Hledat v pozn√°mk√°ch‚Ä¶"
      style="width:100%;height:38px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.88rem;outline:none;" autocomplete="off" />
  </div>

  <!-- FILTR CHIPS -->
  <div class="filter-row" id="filterRow"></div>

  <!-- SEZNAM -->
  <div class="notes-list" id="notesList"></div>

</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span id="toastMsg">Smaz√°no</span>
  <span class="toast-undo" id="toastUndo">Zpƒõt</span>
</div>

<!-- EDIT SHEET -->
<div class="sheet-backdrop" id="editBackdrop">
  <div class="sheet" id="editSheet">
    <div class="sheet-handle"></div>
    <h2 id="editHeading">Upravit pozn√°mku</h2>
    <div>
      <label>Titulek</label>
      <input id="eTitle" type="text" />
    </div>
    <div>
      <label>Text (volitelnƒõ)</label>
      <textarea id="eBody" rows="4"></textarea>
    </div>
    <div>
      <label>Kategorie</label>
      <div class="cats-row" id="eCats" style="flex-wrap:wrap;"></div>
    </div>
    <div>
      <label>Barva</label>
      <div class="palette-row" id="ePalette"></div>
    </div>
    <div class="sheet-actions">
      <button class="sbtn primary" id="editSave">Ulo≈æit</button>
      <button class="sbtn" id="editPin">P≈ôipnout</button>
      <button class="sbtn" id="editArchiveBtn">Archivovat</button>
      <button class="sbtn danger" id="editDelete">Smazat</button>
      <button class="sbtn" id="editCancel">Zru≈°it</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STORAGE (vlastn√≠ kl√≠ƒç, oddƒõleno od hlavn√≠ verze) ‚îÄ‚îÄ
const KEY = 'poznamky_light';

const CATS = [
  { id: 'private',   icon: 'üè†', label: 'Osobn√≠'    },
  { id: 'work',      icon: 'üíº', label: 'Pracovn√≠'  },
  { id: 'idea',      icon: 'üí°', label: 'N√°pad'     },
  { id: 'important', icon: 'üìå', label: 'D≈Øle≈æit√©'  },
  { id: 'critical',  icon: '‚ö†Ô∏è', label: 'Kritick√©'  },
];
const COLORS = ['none','yellow','green','blue','purple','pink'];
const COLOR_CSS = {
  none:'transparent', yellow:'#eab308', green:'#22c55e',
  blue:'#3b82f6', purple:'#a855f7', pink:'#ec4899'
};

function load() {
  try {
    const d = JSON.parse(localStorage.getItem(KEY) || '{"notes":[]}');
    return Array.isArray(d.notes) ? d : { notes: [] };
  } catch(_) { return { notes: [] }; }
}
function save(d) { localStorage.setItem(KEY, JSON.stringify(d)); }
function nowISO() { return new Date().toISOString(); }
function catInfo(id) { return CATS.find(c => c.id === id) || CATS[0]; }
function fmtDate(iso) {
  const d = new Date(iso);
  const today = new Date().toDateString();
  const yest  = new Date(Date.now()-86400000).toDateString();
  if (d.toDateString() === today) return 'Dnes ' + d.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});
  if (d.toDateString() === yest)  return 'Vƒçera ' + d.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString('cs-CZ',{day:'numeric',month:'short'});
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let catFilter   = '';
let searchQ     = '';
let editId      = null;
let editArchived = false;
let undoBuf     = null;
let toastTimer  = null;

// quick add state
let qCat   = 'private';
let qColor = 'none';

// edit state
let eCat   = 'private';
let eColor = 'none';

// ‚îÄ‚îÄ BUILD CAT CHIPS (add form compact) ‚îÄ‚îÄ
function buildQCatsCompact() {
  const box = document.getElementById('qCatsCompact');
  box.innerHTML = '';
  CATS.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'cat-chip' + (qCat === c.id ? ' sel' : '');
    btn.textContent = c.icon + ' ' + c.label;
    btn.onclick = () => { qCat = c.id; buildQCatsCompact(); buildQCatsExpanded(); };
    box.appendChild(btn);
  });
}
function buildQCatsExpanded() {
  const box = document.getElementById('qCats');
  box.innerHTML = '';
  CATS.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'cat-chip' + (qCat === c.id ? ' sel' : '');
    btn.textContent = c.icon + ' ' + c.label;
    btn.onclick = () => { qCat = c.id; buildQCatsCompact(); buildQCatsExpanded(); };
    box.appendChild(btn);
  });
}
function buildQPalette() {
  const box = document.getElementById('qPalette');
  box.innerHTML = '';
  COLORS.forEach(c => {
    const d = document.createElement('div');
    d.className = 'dot' + (qColor === c ? ' sel' : '');
    d.setAttribute('data-c', c);
    d.onclick = () => { qColor = c; buildQPalette(); };
    box.appendChild(d);
  });
}

// ‚îÄ‚îÄ BUILD EDIT CATS/PALETTE ‚îÄ‚îÄ
function buildECats() {
  const box = document.getElementById('eCats');
  box.innerHTML = '';
  CATS.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'cat-chip' + (eCat === c.id ? ' sel' : '');
    btn.textContent = c.icon + ' ' + c.label;
    btn.onclick = () => { eCat = c.id; buildECats(); };
    box.appendChild(btn);
  });
}
function buildEPalette() {
  const box = document.getElementById('ePalette');
  box.innerHTML = '';
  COLORS.forEach(c => {
    const d = document.createElement('div');
    d.className = 'dot' + (eColor === c ? ' sel' : '');
    d.setAttribute('data-c', c);
    d.onclick = () => { eColor = c; buildEPalette(); };
    box.appendChild(d);
  });
}

// ‚îÄ‚îÄ FILTER CHIPS ‚îÄ‚îÄ
function buildFilterChips() {
  const row = document.getElementById('filterRow');
  row.innerHTML = '';
  const all = document.createElement('button');
  all.className = 'fchip' + (catFilter === '' ? ' active' : '');
  all.textContent = 'V≈°e';
  all.onclick = () => { catFilter = ''; buildFilterChips(); render(); };
  row.appendChild(all);
  CATS.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'fchip' + (catFilter === c.id ? ' active' : '');
    btn.textContent = c.icon + ' ' + c.label;
    btn.onclick = () => { catFilter = (catFilter === c.id ? '' : c.id); buildFilterChips(); render(); };
    row.appendChild(btn);
  });
}

// ‚îÄ‚îÄ ADD ‚îÄ‚îÄ
function addNote() {
  const title = document.getElementById('qTitle').value.trim();
  if (!title) return;
  const body = document.getElementById('qBody').value.trim();
  const d = load();
  d.notes.unshift({
    id: 'n_' + Date.now(),
    title, text: body,
    category: qCat, color: qColor,
    pinned: false, archived: false,
    created: nowISO(), updated: nowISO()
  });
  save(d);
  document.getElementById('qTitle').value = '';
  document.getElementById('qBody').value  = '';
  qCat = 'private'; qColor = 'none';
  buildQCatsCompact(); buildQCatsExpanded(); buildQPalette();
  document.getElementById('btnSend').disabled = true;
  collapseExpand(false);
  render();
}

// ‚îÄ‚îÄ EXPAND / COLLAPSE ‚îÄ‚îÄ
let expanded = false;
function collapseExpand(state) {
  expanded = state;
  document.getElementById('qMore').classList.toggle('open', state);
  document.getElementById('qCompact').style.display = state ? 'none' : 'flex';
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function getFiltered(archived) {
  const d = load();
  let arr = d.notes.filter(n => !!n.archived === archived);
  if (catFilter) arr = arr.filter(n => n.category === catFilter);
  if (searchQ)   arr = arr.filter(n =>
    (n.title||'').toLowerCase().includes(searchQ) ||
    (n.text||'').toLowerCase().includes(searchQ)
  );
  arr.sort((a,b) => {
    if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
    return a.updated < b.updated ? 1 : -1;
  });
  return arr;
}

function render() {
  const archived = editArchived;
  const arr = getFiltered(false);
  const list = document.getElementById('notesList');
  list.innerHTML = '';

  // counter
  const all = load().notes.filter(n => !n.archived);
  document.getElementById('counter').innerHTML =
    `<span>${all.length}</span> pozn√°mek celkem`;

  if (!arr.length) {
    list.innerHTML = '<div class="empty">≈Ω√°dn√© pozn√°mky.</div>';
    return;
  }

  arr.forEach(n => {
    const cat = catInfo(n.category);
    const card = document.createElement('div');
    card.className = 'note-card';

    // barevn√Ω prou≈æek
    const bar = document.createElement('div');
    bar.className = 'note-bar';
    bar.style.background = n.color && n.color !== 'none' ? COLOR_CSS[n.color] : 'transparent';

    const body = document.createElement('div');
    body.className = 'note-body';
    body.onclick = () => openEdit(n.id);
    body.innerHTML = `
      <div class="note-head">
        <span class="note-icon">${cat.icon}</span>
        <span class="note-title">${esc(n.title)}</span>
      </div>
      ${n.text ? `<div class="note-preview">${esc(n.text)}</div>` : ''}
      <div class="note-meta">${fmtDate(n.updated)}</div>
    `;

    const acts = document.createElement('div');
    acts.className = 'note-actions';

    const pinBtn = document.createElement('button');
    pinBtn.className = 'nact' + (n.pinned ? ' pin-on' : '');
    pinBtn.textContent = n.pinned ? '‚òÖ' : '‚òÜ';
    pinBtn.title = n.pinned ? 'Odepnout' : 'P≈ôipnout';
    pinBtn.onclick = (e) => { e.stopPropagation(); togglePin(n.id); };

    const delBtn = document.createElement('button');
    delBtn.className = 'nact';
    delBtn.textContent = 'üóë';
    delBtn.title = 'Smazat';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteNote(n.id); };

    acts.append(pinBtn, delBtn);
    card.append(bar, body, acts);
    list.appendChild(card);
  });
}

function esc(s) {
  return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ‚îÄ‚îÄ PIN ‚îÄ‚îÄ
function togglePin(id) {
  const d = load();
  const i = d.notes.findIndex(n => n.id === id);
  if (i >= 0) { d.notes[i].pinned = !d.notes[i].pinned; d.notes[i].updated = nowISO(); save(d); render(); }
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
function deleteNote(id) {
  const d = load();
  const i = d.notes.findIndex(n => n.id === id);
  if (i < 0) return;
  undoBuf = { note: { ...d.notes[i] }, idx: i };
  d.notes.splice(i, 1);
  save(d); render();
  showToast('Smaz√°no');
}

// ‚îÄ‚îÄ EDIT ‚îÄ‚îÄ
function openEdit(id) {
  const d = load();
  const n = d.notes.find(x => x.id === id);
  if (!n) return;
  editId = id;
  document.getElementById('eTitle').value = n.title || '';
  document.getElementById('eBody').value  = n.text  || '';
  eCat   = n.category || 'private';
  eColor = n.color    || 'none';
  buildECats(); buildEPalette();
  // pin button label
  document.getElementById('editPin').textContent = n.pinned ? 'Odepnout' : 'P≈ôipnout';
  // archive / restore
  const archBtn = document.getElementById('editArchiveBtn');
  archBtn.textContent = n.archived ? 'Vr√°tit' : 'Archivovat';
  document.getElementById('editHeading').textContent = n.archived ? 'Archivovan√° pozn√°mka' : 'Upravit pozn√°mku';
  document.getElementById('editBackdrop').classList.add('open');
}
function closeEdit() {
  document.getElementById('editBackdrop').classList.remove('open');
  editId = null;
}

// ‚îÄ‚îÄ ARCHIVE PANEL ‚îÄ‚îÄ
let showArchive = false;
function toggleArchive() {
  showArchive = !showArchive;
  const btn = document.getElementById('btnArchive');
  btn.classList.toggle('active', showArchive);
  renderArchiveOrMain();
}
function renderArchiveOrMain() {
  if (showArchive) renderArchiveList();
  else render();
}
function renderArchiveList() {
  const arr = getFiltered(true);
  const list = document.getElementById('notesList');
  list.innerHTML = '';
  document.getElementById('counter').innerHTML =
    `Archiv ‚Äì <span>${arr.length}</span> pozn√°mek`;
  if (!arr.length) {
    list.innerHTML = '<div class="empty">Archiv je pr√°zdn√Ω.</div>';
    return;
  }
  arr.forEach(n => {
    const cat = catInfo(n.category);
    const card = document.createElement('div');
    card.className = 'note-card';
    const bar = document.createElement('div');
    bar.className = 'note-bar';
    bar.style.background = n.color && n.color !== 'none' ? COLOR_CSS[n.color] : 'transparent';
    const body = document.createElement('div');
    body.className = 'note-body';
    body.style.opacity = '.7';
    body.onclick = () => openEdit(n.id);
    body.innerHTML = `
      <div class="note-head">
        <span class="note-icon">${cat.icon}</span>
        <span class="note-title">${esc(n.title)}</span>
      </div>
      ${n.text ? `<div class="note-preview">${esc(n.text)}</div>` : ''}
      <div class="note-meta">${fmtDate(n.updated)}</div>
    `;
    const acts = document.createElement('div');
    acts.className = 'note-actions';
    const restoreBtn = document.createElement('button');
    restoreBtn.className = 'nact'; restoreBtn.textContent = '‚Ü©';
    restoreBtn.title = 'Vr√°tit';
    restoreBtn.onclick = (e) => { e.stopPropagation(); restoreNote(n.id); };
    const delBtn = document.createElement('button');
    delBtn.className = 'nact'; delBtn.textContent = 'üóë';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteNote(n.id); };
    acts.append(restoreBtn, delBtn);
    card.append(bar, body, acts);
    list.appendChild(card);
  });
}
function restoreNote(id) {
  const d = load();
  const i = d.notes.findIndex(n => n.id === id);
  if (i >= 0) { d.notes[i].archived = false; d.notes[i].updated = nowISO(); save(d); renderArchiveList(); }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  clearTimeout(toastTimer);
  document.getElementById('toastMsg').textContent = msg;
  document.getElementById('toast').classList.add('show');
  toastTimer = setTimeout(hideToast, 5000);
}
function hideToast() {
  clearTimeout(toastTimer);
  document.getElementById('toast').classList.remove('show');
}
function undoDelete() {
  if (!undoBuf) return;
  const d = load();
  d.notes.splice(undoBuf.idx, 0, undoBuf.note);
  save(d); undoBuf = null; hideToast();
  if (showArchive) renderArchiveList(); else render();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  buildQCatsCompact();
  buildQCatsExpanded();
  buildQPalette();
  buildFilterChips();
  render();

  // quick title
  const qTitle = document.getElementById('qTitle');
  qTitle.addEventListener('input', () => {
    document.getElementById('btnSend').disabled = !qTitle.value.trim();
  });
  qTitle.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addNote(); }
  });
  document.getElementById('btnSend').onclick = addNote;

  // expand / collapse
  document.getElementById('btnExpand').onclick   = () => collapseExpand(true);
  document.getElementById('btnCollapse').onclick = () => collapseExpand(false);

  // search toggle
  document.getElementById('btnSearch').onclick = () => {
    const bar = document.getElementById('searchBar');
    const vis = bar.style.display !== 'none';
    bar.style.display = vis ? 'none' : 'block';
    document.getElementById('btnSearch').classList.toggle('active', !vis);
    if (!vis) document.getElementById('qSearch').focus();
    else { searchQ = ''; document.getElementById('qSearch').value = ''; render(); }
  };
  document.getElementById('qSearch').addEventListener('input', e => {
    searchQ = e.target.value.trim().toLowerCase();
    render();
  });

  // archive
  document.getElementById('btnArchive').onclick = toggleArchive;

  // toast undo
  document.getElementById('toastUndo').onclick = undoDelete;

  // edit sheet
  document.getElementById('editSave').onclick = () => {
    if (!editId) return;
    const d = load();
    const i = d.notes.findIndex(n => n.id === editId);
    if (i < 0) return;
    const title = document.getElementById('eTitle').value.trim();
    if (!title) return;
    d.notes[i].title    = title;
    d.notes[i].text     = document.getElementById('eBody').value.trim();
    d.notes[i].category = eCat;
    d.notes[i].color    = eColor;
    d.notes[i].updated  = nowISO();
    save(d); closeEdit();
    if (showArchive) renderArchiveList(); else render();
  };
  document.getElementById('editPin').onclick = () => {
    if (!editId) return;
    const d = load();
    const i = d.notes.findIndex(n => n.id === editId);
    if (i >= 0) { d.notes[i].pinned = !d.notes[i].pinned; d.notes[i].updated = nowISO(); save(d); closeEdit(); render(); }
  };
  document.getElementById('editArchiveBtn').onclick = () => {
    if (!editId) return;
    const d = load();
    const i = d.notes.findIndex(n => n.id === editId);
    if (i < 0) return;
    d.notes[i].archived = !d.notes[i].archived;
    d.notes[i].updated  = nowISO();
    save(d); closeEdit();
    if (showArchive) renderArchiveList(); else render();
  };
  document.getElementById('editDelete').onclick = () => {
    if (!editId) return;
    deleteNote(editId); closeEdit();
  };
  document.getElementById('editCancel').onclick = closeEdit;
  document.getElementById('editBackdrop').addEventListener('click', e => {
    if (e.target === document.getElementById('editBackdrop')) closeEdit();
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeEdit();
  });
});
</script>
</body>
</html>
