<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Cesta ƒç√≠sel</title>
<style>
/* ‚îÄ‚îÄ THEMES ‚Äì v≈ædy tmav√© pozad√≠ ‚îÄ‚îÄ */
:root{
  --bg:#0f172a; --bg2:#0b1220; --bg3:#0c1422; --widget:#111827;
  --text:#e5e7eb; --muted:#94a3b8; --border:rgba(255,255,255,.12);
  --accent:#22c55e; --accent2:#178a3a;
  --cell-hidden:#141f33; --cell-rev:#1a2540; --cell-cur:#1e2d4a;
  --header-bg:rgba(34,197,94,.07); --widget-border:rgba(34,197,94,.22);
  --body-grad:radial-gradient(1200px 600px at 20% -10%,#0d1f0d,transparent);
  --board-bg:#0c1624;
}
[data-theme="blue"]{
  --accent:#3b82f6; --accent2:#1d4ed8;
  --cell-hidden:#0f1e38; --cell-rev:#162240; --cell-cur:#1a2b52;
  --header-bg:rgba(59,130,246,.07); --widget-border:rgba(59,130,246,.25);
  --body-grad:radial-gradient(1200px 600px at 20% -10%,#0a1530,transparent);
  --board-bg:#0b1628;
}
[data-theme="red"]{
  --accent:#ef4444; --accent2:#b91c1c;
  --cell-hidden:#1f0f0f; --cell-rev:#2a1414; --cell-cur:#341818;
  --header-bg:rgba(239,68,68,.07); --widget-border:rgba(239,68,68,.25);
  --body-grad:radial-gradient(1200px 600px at 20% -10%,#1a0a0a,transparent);
  --board-bg:#180c0c;
}
[data-theme="purple"]{
  --accent:#a855f7; --accent2:#7e22ce;
  --cell-hidden:#150f2a; --cell-rev:#1e1540; --cell-cur:#261a50;
  --header-bg:rgba(168,85,247,.07); --widget-border:rgba(168,85,247,.25);
  --body-grad:radial-gradient(1200px 600px at 20% -10%,#120a20,transparent);
  --board-bg:#100c1e;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--body-grad),#080e1a;
  color:var(--text);min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  padding:max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
}

#gameWidget{
  width:min(340px,96vw);
  min-width:280px;
  background:var(--widget);
  border:1px solid var(--widget-border);
  border-radius:18px;
  box-shadow:0 24px 48px rgba(0,0,0,.8),0 0 0 1px rgba(255,255,255,.04);
  overflow:visible;
  animation:pop .25s cubic-bezier(.34,1.56,.64,1);
  user-select:none;
  transition:border-color .3s;
}
@keyframes pop{from{transform:scale(.9) translateY(12px);opacity:0}to{transform:scale(1);opacity:1}}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.g-bar{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 14px 9px;
  background:var(--header-bg);
  border-bottom:1px solid var(--border);
  border-radius:18px 18px 0 0;
}
.g-title{font-size:.78rem;font-weight:700;color:var(--accent);letter-spacing:.06em;text-transform:uppercase;display:flex;align-items:center;gap:6px}
.theme-row{display:flex;gap:5px;align-items:center}
.th-dot{
  width:18px;height:18px;border-radius:50%;cursor:pointer;border:2px solid transparent;
  transition:.15s;flex-shrink:0;
}
.th-dot:hover{transform:scale(1.2)}
.th-dot.active{border-color:var(--text)}
.th-dot[data-t="green"]{background:#22c55e}
.th-dot[data-t="blue"]{background:#3b82f6}
.th-dot[data-t="red"]{background:#ef4444}
.th-dot[data-t="purple"]{background:#a855f7}

/* ‚îÄ‚îÄ LOGO BANNER ‚Äì zobraz√≠ se m√≠sto stats v menu ‚îÄ‚îÄ */
.logo-banner{
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:10px 14px;border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.03));
}
.logo-grid{
  display:grid;grid-template-columns:repeat(3,14px);grid-template-rows:repeat(3,14px);gap:2px;
}
.lg-cell{border-radius:3px;background:var(--cell-hidden);border:1px solid rgba(255,255,255,.07)}
.lg-cell.lit{background:var(--accent);border-color:var(--accent2);box-shadow:0 0 6px rgba(34,197,94,.4)}
.lg-cell.mid{background:var(--cell-rev)}
.logo-text{text-align:left}
.logo-text .lt1{font-size:.78rem;font-weight:900;color:var(--accent);letter-spacing:.08em;text-transform:uppercase}
.logo-text .lt2{font-size:.62rem;color:var(--muted);margin-top:1px}
/* skr√Ωt logo v hern√≠m re≈æimu, skr√Ωt stats v menu */
.score-row{display:flex;gap:6px;padding:8px 10px;border-bottom:1px solid var(--border)}
.score-row.hidden{display:none!important}
.logo-banner.hidden{display:none!important}

/* ‚îÄ‚îÄ STAT ROW boxy ‚îÄ‚îÄ */
.score-box{
  flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:9px;
  padding:6px 8px;text-align:center;
}
.score-lbl{font-size:.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.score-val{font-size:.92rem;font-weight:800;color:var(--text);margin-top:1px}
.score-val.bump{animation:bump .25s ease}
@keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.3);color:var(--accent)}100%{transform:scale(1)}}

/* ‚îÄ‚îÄ BEST TIMES STRIP ‚Äì 3 + ‚ÄûDal≈°√≠" ‚îÄ‚îÄ */
.best-strip{
  display:flex;gap:0;border-bottom:1px solid var(--border);
}
.best-item{
  flex:1;text-align:center;padding:5px 4px;border-right:1px solid var(--border);font-size:.62rem;color:var(--muted);
}
.best-item:last-child{border-right:none}
.best-item strong{color:var(--accent);font-size:.68rem;display:block}

/* ‚îÄ‚îÄ SCREEN SELECT ‚îÄ‚îÄ */
#screenSelect{padding:10px}
.select-title{font-size:.75rem;color:var(--muted);text-align:center;margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em}

/* Mode row */
.mode-row{display:flex;gap:6px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
.mode-btn{
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:6px 10px;font-size:.72rem;font-weight:700;color:var(--muted);cursor:pointer;transition:.15s;
}
.mode-btn:hover,.mode-btn.active{background:var(--cell-rev);border-color:var(--accent);color:var(--accent)}

/* Main 3 cards */
.sizes{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px}
.sizeCard{
  background:var(--bg3);border:1px solid var(--border);border-radius:10px;
  padding:9px 4px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;
  transition:.15s;color:var(--text);position:relative;overflow:hidden;
}
.sizeCard:hover{background:var(--cell-rev);border-color:var(--accent);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.sizeCard .emoji{font-size:18px}
.sizeCard .lbl{font-weight:800;font-size:.82rem}
.sizeCard small{font-size:.62rem;color:var(--muted)}
.sizeCard .best-badge{
  position:absolute;top:5px;right:5px;font-size:.56rem;
  background:var(--accent);color:#000;border-radius:4px;padding:1px 4px;font-weight:700;opacity:.85;
}


.rules{
  background:var(--bg3);border:1px solid var(--border);border-radius:10px;
  padding:9px 12px;font-size:.73rem;color:var(--muted);line-height:1.5;text-align:center;
}

/* ‚îÄ‚îÄ BOARD SCREEN ‚îÄ‚îÄ */
#screenBoard{padding:10px;display:none;flex-direction:column;gap:6px}
#screenBoard.active{display:flex}

/* time attack bar */
.time-attack-bar{
  height:6px;border-radius:3px;background:var(--bg3);overflow:hidden;
  border:1px solid var(--border);display:none;
}
.time-attack-bar.active{display:block}
.tab-fill{
  height:100%;border-radius:3px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  transition:width .25s linear;
}
.tab-fill.warn{background:linear-gradient(90deg,#f59e0b,#d97706)}
.tab-fill.danger{background:linear-gradient(90deg,#ef4444,#b91c1c)}

.board-area{
  position:relative;
  background:var(--board-bg);border-radius:12px;padding:10px;
  border:1px solid var(--border);
}

.progress-bar{height:4px;border-radius:2px;background:var(--bg3);overflow:hidden;margin-top:6px;}
.progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s ease;}

.grid{display:grid;gap:8px}

.cell{
  aspect-ratio:1;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;
  background:var(--cell-hidden);border:1px solid rgba(255,255,255,.06);
  transition:background .12s,transform .1s,box-shadow .15s;
  position:relative;cursor:default;overflow:visible;
}
.cell.revealed{background:var(--cell-rev);color:var(--text)}
.cell.hidden-cell{background:var(--cell-hidden);color:transparent}
.cell.current{
  outline:3px solid #fbbf24;outline-offset:-3px;
  box-shadow:0 0 0 3px rgba(251,191,36,.22),0 8px 18px rgba(0,0,0,.5);
  transform:scale(1.05);
  background:var(--cell-cur);
}
.cell.reveal-flash{animation:revealFlash .4s ease}
@keyframes revealFlash{
  0%{box-shadow:0 0 0 0 rgba(34,197,94,.6)}
  50%{box-shadow:0 0 0 8px rgba(34,197,94,.0);background:rgba(34,197,94,.25)}
  100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}
}
.cell.move-anim{animation:cellJump .15s cubic-bezier(.34,1.56,.64,1)}
@keyframes cellJump{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1.05)}}
.cell.hint-path{outline:2px dashed #38bdf8;outline-offset:-3px}
.cell.hint-goal{outline:3px solid var(--accent);outline-offset:-3px}

/* ‚îÄ‚îÄ STEPS BADGE ‚Äì uvnit≈ô bu≈àky, vespod ‚îÄ‚îÄ */
.steps-badge{
  position:absolute;
  bottom:4px;
  left:50%;
  transform:translateX(-50%);
  min-width:20px;height:20px;
  border-radius:10px;
  padding:0 5px;
  background:#fbbf24;color:#0b1220;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;font-size:.68rem;
  box-shadow:0 2px 6px rgba(0,0,0,.5);
  z-index:3;
  pointer-events:none;
}

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
.status-line{min-height:1.4em;text-align:center;font-size:.78rem;color:var(--muted);padding:0 4px;}
.status-line.warn{color:#f59e0b}
.status-line.lose{color:#f97316}

.blocked-bar{
  display:flex;gap:6px;flex-wrap:wrap;justify-content:center;
  background:var(--bg3);border:1px dashed var(--border);border-radius:10px;padding:8px;
}
.blocked-bar.hidden{display:none}

/* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
.controls{display:flex;flex-direction:column;align-items:center;gap:7px}
.dpad{
  display:grid;
  grid-template-columns:38px 38px 38px;
  grid-template-rows:38px 38px;
  gap:4px;
}
.dpad .spacer{visibility:hidden}
@media(pointer:coarse){.dpad{display:none}}

.btn{
  background:var(--bg3);color:var(--text);border:1px solid var(--border);border-radius:9px;
  padding:8px 12px;font-family:inherit;font-size:.78rem;font-weight:600;
  cursor:pointer;transition:.15s;
}
.btn:hover{background:var(--cell-rev);border-color:rgba(255,255,255,.22)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));border:none;color:#fff}
.btn.primary:hover{opacity:.9}
.dpad .btn{width:38px;height:38px;padding:0;font-size:.95rem;border-radius:8px;display:flex;align-items:center;justify-content:center}
.dpad .btn.pressed{transform:scale(.88);background:var(--cell-cur)}
.btn-row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}

/* ‚îÄ‚îÄ ACTION CARDS ‚Äì barevnƒõ odli≈°en√° hern√≠ tlaƒç√≠tka ‚îÄ‚îÄ */
.act-row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
  width:100%;
}
.act-btn{
  background:var(--bg3);color:var(--text);border:1px solid var(--border);border-radius:10px;
  padding:8px 4px 6px;font-family:inherit;font-size:.7rem;font-weight:700;
  cursor:pointer;transition:.15s;display:flex;flex-direction:column;align-items:center;gap:3px;
  line-height:1.2;
}
.act-btn .act-icon{font-size:1.05rem}
.act-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.act-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.act-btn.c-amber{background:#1c1a00;border-color:#78580a;color:#fbbf24}
.act-btn.c-amber:hover{background:#261f00;border-color:#fbbf24}
.act-btn.c-blue{background:#0a1628;border-color:#1e3a6e;color:#60a5fa}
.act-btn.c-blue:hover{background:#0f1e40;border-color:#60a5fa}
.act-btn.c-slate{background:#0c1422;border-color:rgba(255,255,255,.12);color:#94a3b8}
.act-btn.c-slate:hover{background:#1a2540;border-color:rgba(255,255,255,.25);color:#e5e7eb}
.act-btn.c-more{background:transparent;border-color:rgba(255,255,255,.1);color:#64748b}
.act-btn.c-more:hover{background:#1a2540;border-color:rgba(255,255,255,.2);color:#e5e7eb}

/* ‚îÄ‚îÄ MORE BUBBLE ‚îÄ‚îÄ */
.more{position:relative}
.more-btn{width:34px;height:34px;border-radius:8px;padding:0;background:transparent;border:1px solid var(--border);color:var(--text);font-weight:800;font-size:.85rem;cursor:pointer;}
.bubble{
  position:fixed;bottom:auto;right:12px;
  background:var(--widget);border:1px solid var(--border);border-radius:12px;
  padding:8px;display:flex;flex-direction:column;gap:6px;min-width:200px;
  z-index:20;box-shadow:0 12px 22px rgba(0,0,0,.5);
}
.bubble.hidden{display:none}
.bubble h4{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px}
.bubble .btn{width:100%}
.bubble .tip{font-size:.7rem;color:var(--muted)}

.hint-line{text-align:center;font-size:.7rem;color:rgba(148,163,184,.4);padding-bottom:2px}
.attempt-info{font-size:.65rem;color:rgba(148,163,184,.3);text-align:center}
@media(pointer:coarse){.hint-line{display:none}}
@media(pointer:coarse){.act-btn{min-height:48px;padding:10px 4px 8px}}

/* ‚îÄ‚îÄ WIN OVERLAY ‚îÄ‚îÄ */
.win-overlay{
  display:none;position:fixed;inset:0;z-index:999;
  background:rgba(9,15,28,.93);backdrop-filter:blur(6px);
  align-items:center;justify-content:center;flex-direction:column;
}
.win-overlay.show{display:flex;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.win-box{text-align:center;animation:popIn .3s .1s cubic-bezier(.34,1.56,.64,1) both;padding:20px}
@keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
.win-title{font-size:clamp(36px,10vw,56px);font-weight:900;letter-spacing:2px;color:#fbbf24;text-shadow:0 8px 20px rgba(0,0,0,.6);margin-bottom:8px;}
.win-stats{display:flex;gap:10px;justify-content:center;margin-bottom:14px;flex-wrap:wrap;}
.win-stat{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px 14px;text-align:center;min-width:80px;}
.win-stat .wsl{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
.win-stat .wsv{font-size:1.1rem;font-weight:800;color:var(--text);margin-top:2px}
.win-stat .wsv.new-record{color:#fbbf24;animation:glow 1s ease infinite alternate}
@keyframes glow{from{text-shadow:0 0 4px rgba(251,191,36,.4)}to{text-shadow:0 0 12px rgba(251,191,36,.8)}}
.stars{font-size:1.8rem;margin-bottom:10px;letter-spacing:4px}
.win-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* ‚îÄ‚îÄ LOSE OVERLAY ‚îÄ‚îÄ */
.lose-overlay{display:none;position:fixed;inset:0;z-index:999;background:rgba(9,15,28,.93);backdrop-filter:blur(6px);align-items:center;justify-content:center;}
.lose-overlay.show{display:flex;animation:fadeIn .2s ease}
.lose-box{text-align:center;animation:popIn .3s .1s cubic-bezier(.34,1.56,.64,1) both;padding:20px}
.lose-title{font-size:clamp(28px,8vw,44px);font-weight:900;letter-spacing:2px;color:#f97316;text-shadow:0 8px 20px rgba(0,0,0,.6);margin-bottom:8px;}
.lose-sub{font-size:.9rem;color:var(--muted);margin-bottom:16px}

/* ‚îÄ‚îÄ SHARE TOAST ‚îÄ‚îÄ */
.share-toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);
  background:#111827;border:1px solid var(--accent);color:var(--text);
  border-radius:10px;padding:8px 16px;font-size:.8rem;font-weight:600;
  opacity:0;transition:.3s;z-index:9999;pointer-events:none;
}
.share-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<div id="gameWidget">

  <!-- Header -->
  <div class="g-bar">
    <div class="g-title">üß≠ <span>Cesta ƒç√≠sel</span></div>
    <div class="theme-row">
      <div class="th-dot active" data-t="green"></div>
      <div class="th-dot" data-t="blue"></div>
      <div class="th-dot" data-t="red"></div>
      <div class="th-dot" data-t="purple"></div>
    </div>
  </div>

  <!-- Logo banner ‚Äì viditeln√© jen v menu -->
  <div class="logo-banner" id="logoBanner">
    <div class="logo-grid">
      <div class="lg-cell lit"></div><div class="lg-cell mid"></div><div class="lg-cell"></div>
      <div class="lg-cell"></div><div class="lg-cell lit"></div><div class="lg-cell mid"></div>
      <div class="lg-cell mid"></div><div class="lg-cell"></div><div class="lg-cell lit"></div>
    </div>
    <div class="logo-text">
      <div class="lt1">Cesta ƒç√≠sel</div>
      <div class="lt2">Odkryj celou m≈ô√≠≈æku</div>
    </div>
  </div>

  <!-- Stats ‚Äì viditeln√© jen p≈ôi h≈ôe -->
  <div class="score-row hidden" id="scoreRow">
    <div class="score-box">
      <div class="score-lbl">Odkryto</div>
      <div class="score-val" id="revealedStat">‚Äî</div>
    </div>
    <div class="score-box">
      <div class="score-lbl">Tahy</div>
      <div class="score-val" id="movesStat">‚Äî</div>
    </div>
    <div class="score-box">
      <div class="score-lbl">ƒåas</div>
      <div class="score-val" id="timeStat">‚Äî</div>
    </div>
  </div>

  <!-- Best times ‚Äì pouze 3 klasick√© -->
  <div class="best-strip" id="bestStrip">
    <div class="best-item">2√ó2<strong id="best2">‚Äî</strong></div>
    <div class="best-item">3√ó3<strong id="best3">‚Äî</strong></div>
    <div class="best-item">4√ó4<strong id="best4">‚Äî</strong></div>
  </div>

  <!-- Select screen -->
  <div id="screenSelect">
    <div class="select-title">Vyber velikost m≈ô√≠≈æky</div>

    <!-- Mode -->
    <div class="mode-row" id="modeRow">
      <button class="mode-btn active" data-mode="normal">‚öîÔ∏è Norm√°ln√≠</button>
      <button class="mode-btn" data-mode="30">‚è± 30 s</button>
      <button class="mode-btn" data-mode="60">‚è± 60 s</button>
      <button class="mode-btn" data-mode="90">‚è± 90 s</button>
    </div>

    <!-- 3 hlavn√≠ velikosti -->
    <div class="sizes">
      <button class="sizeCard" data-size="2"><div class="emoji">üü¶</div><div class="lbl">2 √ó 2</div><small>rozeh≈ô√°t√≠</small></button>
      <button class="sizeCard" data-size="3"><div class="emoji">üü©</div><div class="lbl">3 √ó 3</div><small>ide√°ln√≠</small></button>
      <button class="sizeCard" data-size="4"><div class="emoji">üü®</div><div class="lbl">4 √ó 4</div><small>v√Ωzva</small></button>
    </div>


    <div class="rules">
      Pohybuj se ‚ÜïÔ∏é‚ÜîÔ∏é (ne diagon√°lnƒõ). Udƒõlej p≈ôesnƒõ tolik krok≈Ø, kolik ukazuje ƒç√≠slo, a skonƒçi na <em>skryt√©</em> bu≈àce.
    </div>
  </div>

  <!-- Board screen -->
  <div id="screenBoard">
    <div class="time-attack-bar" id="timeAttackBar">
      <div class="tab-fill" id="tabFill" style="width:100%"></div>
    </div>

    <div class="board-area">
      <div id="board" class="grid"></div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    </div>

    <div class="status-line" id="statusLine"></div>

    <div id="blockedBar" class="blocked-bar hidden">
      <button class="btn" id="altRepeat">Opakovat</button>
      <button class="btn" id="altPick">Vybrat start</button>
      <button class="btn" id="altNew">Nov√° hra</button>
      <button class="btn" id="altMenu">Menu</button>
    </div>

    <div class="controls">
      <div class="dpad" id="dpad">
        <div class="spacer"></div>
        <button class="btn" id="btnUp">‚ñ≤</button>
        <div class="spacer"></div>
        <button class="btn" id="btnLeft">‚óÄ</button>
        <button class="btn" id="btnDown">‚ñº</button>
        <button class="btn" id="btnRight">‚ñ∂</button>
      </div>

      <!-- Jeden ≈ô√°dek akƒçn√≠ch karet s podbarven√≠m -->
      <div class="act-row">
        <button class="act-btn c-amber" id="undoTurnBtn">
          <span class="act-icon">‚Ü©</span>Zpƒõt
        </button>
        <button class="act-btn c-blue" id="hintBtn">
          <span class="act-icon">üí°</span>N√°povƒõda
        </button>
        <button class="act-btn c-slate" id="menuBtn">
          <span class="act-icon">‚ò∞</span>Menu
        </button>
        <div class="more" style="display:contents">
          <button class="act-btn c-more" id="moreBtn">
            <span class="act-icon">‚ãØ</span>V√≠ce
          </button>
          <div id="moreBubble" class="bubble hidden">
            <h4>Mo≈ænosti</h4>
            <button class="btn" id="restartBtn">Nov√© rozlo≈æen√≠</button>
            <button class="btn" id="repeatBtn">Jin√Ω start</button>
            <button class="btn" id="pickStartBtn">Vybrat start</button>
            <button class="btn" id="shareBtn">üìã Sd√≠let</button>
            <div class="tip" style="margin-top:4px">Na mobilu t√°hni prstem.</div>
          </div>
        </div>
      </div>

      <div class="attempt-info" id="attemptInfo"></div>
    </div>

    <div class="hint-line">‚Üê ‚Üí ‚Üë ‚Üì kl√°vesy pro pohyb</div>
  </div>

</div>

<!-- Win overlay -->
<div class="win-overlay" id="winOverlay">
  <div class="win-box">
    <div class="stars" id="winStars">‚≠ê‚≠ê‚≠ê</div>
    <div class="win-title">üéâ V√ùHRA!</div>
    <div class="win-stats">
      <div class="win-stat"><div class="wsl">ƒåas</div><div class="wsv" id="wTime">‚Äî</div></div>
      <div class="win-stat"><div class="wsl">Tahy</div><div class="wsv" id="wMoves">‚Äî</div></div>
      <div class="win-stat"><div class="wsl">M≈ô√≠≈æka</div><div class="wsv" id="wSize">‚Äî</div></div>
      <div class="win-stat"><div class="wsl">Rekord</div><div class="wsv" id="wBest">‚Äî</div></div>
    </div>
    <div class="win-actions">
      <button class="btn primary" id="winRepeat">Opakovat</button>
      <button class="btn" id="winNew">Nov√° hra</button>
      <button class="btn" id="winShare">üìã Sd√≠let</button>
      <button class="btn" id="winMenu">Menu</button>
    </div>
  </div>
</div>

<!-- Lose overlay -->
<div class="lose-overlay" id="loseOverlay">
  <div class="lose-box">
    <div class="lose-title" id="loseTitle">üíÄ KONEC!</div>
    <div class="lose-sub" id="loseSub"></div>
    <div class="win-actions">
      <button class="btn primary" id="loseRepeat">Znovu</button>
      <button class="btn" id="loseNew">Nov√° hra</button>
      <button class="btn" id="loseMenu">Menu</button>
    </div>
  </div>
</div>

<div class="share-toast" id="shareToast">üìã Zkop√≠rov√°no!</div>

<script>
(function(){
'use strict';

// ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ
const AC=window.AudioContext||window.webkitAudioContext;
let ac=null;
function ensureAC(){if(!ac&&AC)try{ac=new AC();}catch(e){}}
function playTone(freq,dur=0.08,type='sine',gain=0.18){
  ensureAC();if(!ac)return;
  try{const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
    o.frequency.value=freq;o.type=type;
    g.gain.setValueAtTime(gain,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
    o.start();o.stop(ac.currentTime+dur);}catch(e){}
}
function playClick(){playTone(440,.06,'sine',.12);}
function playReveal(){playTone(660,.12,'sine',.15);setTimeout(()=>playTone(880,.1,'sine',.1),80);}
function playError(){playTone(200,.15,'sawtooth',.12);}
function playFanfare(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>playTone(f,.18,'sine',.18),i*110));}
function playTimerWarn(){playTone(880,.08,'square',.08);}
function playLose(){playTone(300,.2,'sawtooth',.15);setTimeout(()=>playTone(220,.3,'sawtooth',.12),200);}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let size=3,total=9;
let values=[],revealed=[];
let currentIndex=-1,stepsRemaining=0;
let gameOver=false,turnStartIndex=-1,strictBlocked=false,selectStartMode=false;
let moveCount=0;
let tStart=0,tTimer=null;
let timeAttackLimit=0;
let taTimer=null,taRemaining=0;

const BEST_KEY='cesta_best_v3';
const THEME_KEY='cesta_theme';

const $=id=>document.getElementById(id);
const screenSelect=$('screenSelect'),screenBoard=$('screenBoard');
const board=$('board');
const revealedStat=$('revealedStat'),movesStat=$('movesStat'),timeStat=$('timeStat');
const statusLine=$('statusLine'),attemptInfo=$('attemptInfo');
const winOverlay=$('winOverlay'),loseOverlay=$('loseOverlay');
const blockedBar=$('blockedBar'),moreBubble=$('moreBubble');
const tabFill=$('tabFill'),timeAttackBar=$('timeAttackBar');
const progressFill=$('progressFill');

const vibrate=p=>navigator.vibrate?.(p);
const idx=(r,c)=>r*size+c;
const rc=i=>[Math.floor(i/size),i%size];
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}
function countRevealed(){return revealed.filter(Boolean).length;}
function atTurnStart(){return currentIndex===turnStartIndex&&stepsRemaining===values[turnStartIndex];}
const fmtTime=ms=>{const s=Math.floor(ms/1000),m=Math.floor(s/60);return`${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;};
const fmtSecs=s=>{const m=Math.floor(s/60);return`${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;};

// ‚îÄ‚îÄ BEST TIMES ‚îÄ‚îÄ
function loadBests(){try{return JSON.parse(localStorage.getItem(BEST_KEY)||'{}')}catch(e){return{}}}
function saveBest(n,secs){const b=loadBests();if(!b[n]||secs<b[n]){b[n]=secs;localStorage.setItem(BEST_KEY,JSON.stringify(b));return true;}return false;}
function getBest(n){const b=loadBests();return b[n]||null;}
function updateBestStrip(){
  [2,3,4].forEach(n=>{const v=getBest(n);$('best'+n).textContent=v?fmtSecs(v):'‚Äî';});
}
function updateSizeCardBadges(){
  document.querySelectorAll('.sizeCard').forEach(c=>{
    const n=Number(c.dataset.size);const v=getBest(n);
    let badge=c.querySelector('.best-badge');
    if(v){if(!badge){badge=document.createElement('div');badge.className='best-badge';c.appendChild(badge);}badge.textContent=fmtSecs(v);}
  });
}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
function applyTheme(t){
  document.body.removeAttribute('data-theme');
  if(t!=='green') document.body.setAttribute('data-theme',t);
  document.querySelectorAll('.th-dot').forEach(d=>d.classList.toggle('active',d.dataset.t===t));
  try{localStorage.setItem(THEME_KEY,t);}catch(e){}
}
document.querySelectorAll('.th-dot').forEach(d=>d.addEventListener('click',()=>applyTheme(d.dataset.t)));
try{const t=localStorage.getItem(THEME_KEY);if(t)applyTheme(t);}catch(e){}

// ‚îÄ‚îÄ MODE SELECT ‚îÄ‚îÄ
let selectedMode='normal';
$('modeRow').addEventListener('click',e=>{
  const b=e.target.closest('.mode-btn');if(!b)return;
  selectedMode=b.dataset.mode;
  document.querySelectorAll('.mode-btn').forEach(x=>x.classList.toggle('active',x===b));
});

// ‚îÄ‚îÄ BFS ‚îÄ‚îÄ
function findPathToHidden(startIndex,k){
  if(k===0)return !revealed[startIndex]?[]:null;
  const q=[{i:startIndex,d:0,path:[]}],seen=new Set();
  while(q.length){
    const {i,d,path}=q.shift(),key=i+'|'+d;
    if(seen.has(key))continue;seen.add(key);
    const [r,c]=rc(i),n=[];
    if(r>0)n.push(idx(r-1,c));if(r<size-1)n.push(idx(r+1,c));
    if(c>0)n.push(idx(r,c-1));if(c<size-1)n.push(idx(r,c+1));
    for(const ni of n){
      const nd=d+1,np=path.concat(ni);
      if(nd===k){if(!revealed[ni])return np;}
      else if(nd<k)q.push({i:ni,d:nd,path:np});
    }
  }
  return null;
}
const existsPathToHidden=(i,k)=>!!findPathToHidden(i,k);

// ‚îÄ‚îÄ SOLVABILITY ‚îÄ‚îÄ
function isSolvable(vals,startIndex,N){
  const ALL=(1n<<BigInt(N*N))-1n,memo=new Map();
  function dfs(mask,i){
    if(mask===ALL)return true;
    const key=mask.toString()+'|'+i;if(memo.has(key))return memo.get(key);
    const k=vals[i];
    for(let j=0;j<N*N;j++){
      const bit=(1n<<BigInt(j));
      if((mask&bit)!==0n)continue;
      if(!existsPathLength(i,j,k,N))continue;
      if(dfs(mask|bit,j)){memo.set(key,true);return true;}
    }
    memo.set(key,false);return false;
  }
  function existsPathLength(from,to,k,N){const sd=shortestDistance(from,to,N);return sd>=0&&sd<=k&&(k-sd)%2===0;}
  function shortestDistance(from,to,N){
    if(from===to)return 0;
    const q=[from],dist=Array(N*N).fill(-1);dist[from]=0;
    while(q.length){
      const v=q.shift(),r=Math.floor(v/N),c=v%N,n=[];
      if(r>0)n.push((r-1)*N+c);if(r<N-1)n.push((r+1)*N+c);
      if(c>0)n.push(r*N+c-1);if(c<N-1)n.push(r*N+c+1);
      for(const u of n){if(dist[u]!==-1)continue;dist[u]=dist[v]+1;if(u===to)return dist[u];q.push(u);}
    }
    return -1;
  }
  return dfs(1n<<BigInt(startIndex),startIndex);
}
function generateSolvableLayout(N,maxAttempts=9000){
  const tot=N*N;let attempts=0;
  while(attempts++<maxAttempts){
    const vals=shuffle(Array.from({length:tot},(_,i)=>i+1));
    const starts=shuffle(Array.from({length:tot},(_,i)=>i));
    for(const s of starts){if(isSolvable(vals,s,N))return{values:vals,start:s,attempts};}
  }
  return null;
}

// ‚îÄ‚îÄ FONT SIZE ‚îÄ‚îÄ
function cellFontSize(n){return n<=3?'1.3rem':n===4?'1.1rem':n===5?'0.95rem':n<=7?'0.82rem':'0.7rem';}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderBoard(){
  board.innerHTML='';
  board.style.gridTemplateColumns=`repeat(${size},1fr)`;
  // men≈°√≠ gap pro velk√© m≈ô√≠≈æky
  board.style.gap=size>=8?'4px':size>=6?'6px':'8px';
  const fs=cellFontSize(size);
  for(let i=0;i<total;i++){
    const el=document.createElement('div');
    el.className='cell '+(revealed[i]?'revealed':'hidden-cell');
    el.dataset.index=i;
    el.style.fontSize=fs;

    if(revealed[i]) el.textContent=values[i];

    if(i===currentIndex){
      el.classList.add('current');
      if(!gameOver&&stepsRemaining>0){
        // Badge uvnit≈ô bu≈àky ‚Äì zb√Ωvaj√≠c√≠ kroky
        const badge=document.createElement('div');
        badge.className='steps-badge';
        badge.textContent=stepsRemaining;
        el.appendChild(badge);
      }
    }
    board.appendChild(el);
  }
  revealedStat.textContent=`${countRevealed()}/${total}`;
  movesStat.textContent=moveCount;
  const pct=countRevealed()/total*100;
  progressFill.style.width=pct+'%';
}

function flashCell(index,cls){
  const cells=[...board.querySelectorAll('.cell')];
  if(cells[index]){cells[index].classList.add(cls);setTimeout(()=>cells[index].classList.remove(cls),400);}
}

function setStatus(msg,type='info'){
  statusLine.className='status-line'+(type==='warn'?' warn':type==='lose'?' lose':'');
  statusLine.textContent=msg;
}

// ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ
function showSelect(){
  screenSelect.style.display='';
  screenBoard.classList.remove('active');
  selectStartMode=false;
  hideWin();hideLose();stopTimer();stopTA();
  $('logoBanner').classList.remove('hidden');
  $('scoreRow').classList.add('hidden');
  revealedStat.textContent='‚Äî';movesStat.textContent='‚Äî';timeStat.textContent='‚Äî';
  updateBestStrip();updateSizeCardBadges();
}
function showBoardScreen(){
  screenSelect.style.display='none';
  screenBoard.classList.add('active');
  $('logoBanner').classList.add('hidden');
  $('scoreRow').classList.remove('hidden');
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function startTimer(){stopTimer();tStart=Date.now();timeStat.textContent='00:00';tTimer=setInterval(()=>{timeStat.textContent=fmtTime(Date.now()-tStart);},250);}
function stopTimer(){if(tTimer){clearInterval(tTimer);tTimer=null;}}

// ‚îÄ‚îÄ TIME ATTACK ‚îÄ‚îÄ
function startTA(secs){
  stopTA();taRemaining=secs;
  timeAttackBar.classList.add('active');
  tabFill.style.width='100%';tabFill.className='tab-fill';
  taTimer=setInterval(()=>{
    taRemaining--;
    const pct=Math.max(0,taRemaining/secs*100);
    tabFill.style.width=pct+'%';
    if(pct<20&&!tabFill.classList.contains('danger'))tabFill.className='tab-fill danger';
    else if(pct<40&&!tabFill.classList.contains('warn')&&!tabFill.classList.contains('danger'))tabFill.className='tab-fill warn';
    if(taRemaining<=10&&taRemaining>0&&taRemaining%2===0)playTimerWarn();
    if(taRemaining<=0){stopTA();stopTimer();loseGame('‚è± ƒåas vypr≈°el!',`Odkryto: ${countRevealed()}/${total}`);}
  },1000);
}
function stopTA(){if(taTimer){clearInterval(taTimer);taTimer=null;}timeAttackBar.classList.remove('active');}

function resetAttemptState(startIndex){currentIndex=startIndex;stepsRemaining=values[startIndex];turnStartIndex=startIndex;strictBlocked=false;}

// ‚îÄ‚îÄ BLOCKED BAR ‚îÄ‚îÄ
function updateBlockedBar(){
  const show=strictBlocked&&atTurnStart();
  blockedBar.classList.toggle('hidden',!show);
  $('undoTurnBtn').disabled=show;
}
function postMoveCheck(){
  if(stepsRemaining>0){
    const has=existsPathToHidden(currentIndex,stepsRemaining);
    strictBlocked=!has;
    setStatus(has?'':`‚õî Pro hodnotu ${stepsRemaining} z t√©to pozice NEM√Å ≈ôe≈°en√≠.`,has?'info':'warn');
  }else{strictBlocked=false;setStatus('');}
  updateButtonsState();updateBlockedBar();renderBoard();
}
function updateButtonsState(){
  const dis=gameOver||strictBlocked;
  [$('btnUp'),$('btnDown'),$('btnLeft'),$('btnRight')].forEach(b=>b.disabled=dis);
  $('hintBtn').disabled=gameOver||stepsRemaining===0;
}

// ‚îÄ‚îÄ STARS ‚îÄ‚îÄ
function calcStars(elapsed,n){
  const t={2:[10,20],3:[30,60],4:[90,180],5:[150,300],6:[240,480]}[n]||[elapsed*0.5,elapsed*0.8];
  return elapsed<=t[0]?3:elapsed<=t[1]?2:1;
}

// ‚îÄ‚îÄ NEW GAME ‚îÄ‚îÄ
function startNewGame(N,limit){
  hideWin();hideLose();gameOver=false;strictBlocked=false;closeMore();
  size=N;total=N*N;moveCount=0;
  timeAttackLimit=(limit&&limit!=='normal')?Number(limit):0;
  movesStat.textContent='0';
  const gen=generateSolvableLayout(N);
  if(!gen){setStatus('Nepoda≈ôilo se vygenerovat. Zkus znovu.','lose');return;}
  values=gen.values.slice();
  revealed=Array(total).fill(false);revealed[gen.start]=true;
  resetAttemptState(gen.start);
  attemptInfo.textContent=`≈òe≈°iteln√© po ${gen.attempts} pokusech.`;
  updateBestStrip();
  renderBoard();updateButtonsState();postMoveCheck();startTimer();
  if(timeAttackLimit)startTA(timeAttackLimit);
  vibrate(10);
}
function startNewGameSameSize(){startNewGame(size,timeAttackLimit||selectedMode);}
function repeatSameLayout(){
  hideWin();hideLose();if(!values||values.length!==total){startNewGameSameSize();return;}
  gameOver=false;strictBlocked=false;closeMore();moveCount=0;movesStat.textContent='0';
  revealed=Array(total).fill(false);
  let start=Math.floor(Math.random()*total);
  if(total>1){let g=0;while(start===turnStartIndex&&g++<30){start=Math.floor(Math.random()*total);}}
  revealed[start]=true;resetAttemptState(start);attemptInfo.textContent='';
  renderBoard();updateButtonsState();postMoveCheck();startTimer();
  if(timeAttackLimit)startTA(timeAttackLimit);
  vibrate([8,30,8]);
}
function pickStart(){
  hideWin();hideLose();if(!values||values.length!==total){startNewGameSameSize();return;}
  gameOver=false;strictBlocked=false;closeMore();
  revealed=Array(total).fill(false);selectStartMode=true;
  setStatus('Klikni na bu≈àku, odkud chce≈° zaƒç√≠t.');renderBoard();updateButtonsState();timeStat.textContent='00:00';
}

// ‚îÄ‚îÄ MOVE ‚îÄ‚îÄ
function tryMove(dr,dc){
  if(gameOver||stepsRemaining<=0)return;
  if(strictBlocked){vibrate([10,30,10]);playError();return;}
  const [r,c]=rc(currentIndex),nr=r+dr,nc=c+dc;
  if(nr<0||nr>=size||nc<0||nc>=size){setStatus('Nem≈Ø≈æe≈° mimo m≈ô√≠≈æku.');vibrate([20,20,20]);playError();return;}
  currentIndex=idx(nr,nc);stepsRemaining--;moveCount++;
  movesStat.classList.remove('bump');void movesStat.offsetWidth;movesStat.classList.add('bump');
  setStatus('');vibrate(8);playClick();renderBoard();updateButtonsState();
  setTimeout(()=>{const cells=[...board.querySelectorAll('.cell')];if(cells[currentIndex])cells[currentIndex].classList.add('move-anim');},10);
  if(stepsRemaining===0){
    if(!revealed[currentIndex]){
      revealed[currentIndex]=true;
      flashCell(currentIndex,'reveal-flash');playReveal();
      if(countRevealed()===total){
        stepsRemaining=0;gameOver=true;updateButtonsState();renderBoard();stopTimer();stopTA();
        const elapsedSecs=Math.round((Date.now()-tStart)/1000);
        const isRecord=!timeAttackLimit?saveBest(size,elapsedSecs):false;
        showWin(elapsedSecs,isRecord);return;
      }
      resetAttemptState(currentIndex);renderBoard();updateButtonsState();postMoveCheck();vibrate([15,30,15]);
    }else{
      gameOver=true;stopTimer();stopTA();playLose();vibrate([40,60,40]);updateButtonsState();renderBoard();
      loseGame('üíÄ Prohra!','Skonƒçil jsi na odtajnƒõn√© bu≈àce.');
    }
  }else{postMoveCheck();}
}

// ‚îÄ‚îÄ UNDO ‚îÄ‚îÄ
function undoToTurnStart(){
  hideWin();hideLose();gameOver=false;currentIndex=turnStartIndex;stepsRemaining=values[turnStartIndex];strictBlocked=false;
  setStatus('');renderBoard();updateButtonsState();postMoveCheck();vibrate([8,8,12]);
}

// ‚îÄ‚îÄ HINT ‚îÄ‚îÄ
function showHint(){
  if(gameOver||stepsRemaining===0)return;
  const path=findPathToHidden(currentIndex,stepsRemaining);
  if(!path){setStatus(`Pro hodnotu ${stepsRemaining} NEM√Å ≈ôe≈°en√≠.`,'warn');vibrate([30,30,30]);playError();return;}
  const cells=[...board.querySelectorAll('.cell')];
  for(let i=0;i<path.length-1;i++)cells[path[i]].classList.add('hint-path');
  cells[path[path.length-1]].classList.add('hint-goal');
  setTimeout(()=>{cells.forEach(el=>el.classList.remove('hint-path','hint-goal'));if(!gameOver)postMoveCheck();},1200);
  vibrate([10,15,10]);
}

// ‚îÄ‚îÄ WIN ‚îÄ‚îÄ
function showWin(elapsedSecs,isRecord){
  const stars=calcStars(elapsedSecs,size);
  $('winStars').textContent='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars);
  $('wTime').textContent=fmtSecs(elapsedSecs);
  $('wMoves').textContent=moveCount;
  $('wSize').textContent=`${size}√ó${size}`;
  const best=getBest(size);
  $('wBest').textContent=best?fmtSecs(best):'‚Äî';
  if(isRecord)$('wBest').classList.add('new-record');else $('wBest').classList.remove('new-record');
  winOverlay.classList.add('show');closeMore();blockedBar.classList.add('hidden');
  updateBestStrip();playFanfare();vibrate([30,40,30,60,50]);
}
function hideWin(){winOverlay.classList.remove('show');}

// ‚îÄ‚îÄ LOSE ‚îÄ‚îÄ
function loseGame(title,sub){$('loseTitle').textContent=title;$('loseSub').textContent=sub;loseOverlay.classList.add('show');closeMore();}
function hideLose(){loseOverlay.classList.remove('show');}

// ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ
function buildShareText(){
  const pct=Math.round(countRevealed()/total*100);
  const mode=timeAttackLimit?`‚è±${timeAttackLimit}s`:'‚öîÔ∏è';
  return`üß≠ Cesta ƒç√≠sel ${size}√ó${size} ${mode}\nüìä Odkryto: ${countRevealed()}/${total} (${pct}%)\n‚è± ƒåas: ${timeStat.textContent}\nüë£ Tahy: ${moveCount}`;
}
function shareResult(){
  const text=buildShareText();
  if(navigator.clipboard)navigator.clipboard.writeText(text).then(()=>showToast()).catch(()=>fallbackShare(text));
  else fallbackShare(text);
}
function fallbackShare(text){prompt('Zkop√≠ruj v√Ωsledek:',text);}
function showToast(){const t=$('shareToast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}

// ‚îÄ‚îÄ MORE BUBBLE ‚îÄ‚îÄ
function toggleMore(){
  const bubble=moreBubble;
  const btn=$('moreBtn');
  if(bubble.classList.contains('hidden')){
    const r=btn.getBoundingClientRect();
    bubble.style.bottom=(window.innerHeight-r.top+6)+'px';
    bubble.style.right=(window.innerWidth-r.right)+'px';
    bubble.classList.remove('hidden');
  } else {
    bubble.classList.add('hidden');
  }
}
function closeMore(){moreBubble.classList.add('hidden');}
$('moreBtn').addEventListener('click',e=>{e.stopPropagation();toggleMore();});
document.addEventListener('click',e=>{if(!moreBubble.contains(e.target)&&e.target!==$('moreBtn'))closeMore();});

// ‚îÄ‚îÄ DPAD highlight ‚îÄ‚îÄ
const dirMap={ArrowUp:'btnUp',ArrowDown:'btnDown',ArrowLeft:'btnLeft',ArrowRight:'btnRight'};
function highlightDpad(key){const id=dirMap[key];if(!id)return;const b=$(id);if(!b)return;b.classList.add('pressed');setTimeout(()=>b.classList.remove('pressed'),150);}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
$('btnUp').addEventListener('click',()=>tryMove(-1,0));
$('btnDown').addEventListener('click',()=>tryMove(1,0));
$('btnLeft').addEventListener('click',()=>tryMove(0,-1));
$('btnRight').addEventListener('click',()=>tryMove(0,1));
$('undoTurnBtn').addEventListener('click',undoToTurnStart);
$('hintBtn').addEventListener('click',showHint);
$('menuBtn').addEventListener('click',()=>{hideWin();hideLose();showSelect();});
$('restartBtn').addEventListener('click',startNewGameSameSize);
$('repeatBtn').addEventListener('click',repeatSameLayout);
$('pickStartBtn').addEventListener('click',pickStart);
$('shareBtn').addEventListener('click',()=>{shareResult();closeMore();});
$('altRepeat').addEventListener('click',repeatSameLayout);
$('altPick').addEventListener('click',pickStart);
$('altNew').addEventListener('click',startNewGameSameSize);
$('altMenu').addEventListener('click',()=>{hideWin();hideLose();showSelect();});
$('winRepeat').addEventListener('click',repeatSameLayout);
$('winNew').addEventListener('click',startNewGameSameSize);
$('winShare').addEventListener('click',shareResult);
$('winMenu').addEventListener('click',()=>{hideWin();showSelect();});
$('loseRepeat').addEventListener('click',()=>{hideLose();repeatSameLayout();});
$('loseNew').addEventListener('click',()=>{hideLose();startNewGameSameSize();});
$('loseMenu').addEventListener('click',()=>{hideLose();showSelect();});

window.addEventListener('keydown',e=>{
  const moves={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1]};
  if(moves[e.key]){e.preventDefault();highlightDpad(e.key);if(!gameOver&&!strictBlocked)tryMove(...moves[e.key]);}
  if(e.key==='?')toggleMore();
});

let sX=null,sY=null;
board.addEventListener('pointerdown',e=>{sX=e.clientX;sY=e.clientY;});
board.addEventListener('pointerup',e=>{
  if(sX==null)return;
  const dx=e.clientX-sX,dy=e.clientY-sY;sX=sY=null;
  const T=24;if(Math.abs(dx)<T&&Math.abs(dy)<T)return;
  if(gameOver||strictBlocked)return;
  if(Math.abs(dx)>Math.abs(dy))tryMove(0,dx>0?1:-1);else tryMove(dy>0?1:-1,0);
});

board.addEventListener('click',e=>{
  if(!selectStartMode)return;
  const cell=e.target.closest('.cell');if(!cell)return;
  const si=Number(cell.dataset.index);
  revealed=Array(total).fill(false);revealed[si]=true;selectStartMode=false;
  resetAttemptState(si);setStatus('');renderBoard();updateButtonsState();postMoveCheck();vibrate([10,20]);startTimer();
  if(timeAttackLimit)startTA(timeAttackLimit);
});

$('screenSelect').addEventListener('click',e=>{
  const btn=e.target.closest('[data-size]');if(!btn)return;
  const chosen=Number(btn.dataset.size);
  showBoardScreen();startNewGame(chosen,selectedMode);
});

updateBestStrip();
showSelect();
})();
</script>
</body>
</html>
